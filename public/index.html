<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Moneda del Vecindario</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="/output.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <!-- PWA Support -->
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    <link rel="icon" href="/favicon.ico">
    <script>
        // Definir showErrorMessage en el Ã¡mbito global
        function showErrorMessage(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
            } else {
                console.warn(`Elemento con ID ${elementId} no encontrado: ${message}`);
                const fallbackElement = document.getElementById('message-box');
                if (fallbackElement) {
                    fallbackElement.textContent = message;
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background: url('/images/background.jpg') no-repeat center center fixed;
            background-size: cover;
            background-color: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            image-rendering: pixelated;
        }
        #game-container, #auth-container, #settings-container, #policies-container, #chat-container {
            display: none;
            flex-direction: column;
            align-items: center;
            margin-top: 1rem;
            width: 100%;
            max-width: 500px;
        }
        #auth-container.active, #game-container.active, #settings-container.active, #policies-container.active {
            display: flex;
        }
        #auth-form, #settings-form, #policies-form, #withdraw-form, #reload-form, #chat-container, #confirm-reload-modal {
            background-color: rgba(0, 0, 0, 0.9);
            padding: 1rem;
            border: 4px solid #ffeb3b;
            border-radius: 8px;
            box-shadow: 0 0 10px #ffeb3b, 0 0 20px #e91e63;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        #confirm-reload-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: none;
        }
        #confirm-reload-modal.active {
            display: block;
        }
        #auth-form input, #settings-form input, #withdraw-form input, #withdraw-form select, #reload-form input, #message-input, #confirm-reload-modal input {
            width: 100%;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border: 2px solid #03a9f4;
            border-radius: 4px;
            background-color: #1a237e;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem;
        }
        #auth-form button, #settings-form button, #policies-form button, #withdraw-form button, #reload-form button, #stats-button, #record-button, #send-button, #confirm-reload-modal button {
            padding: 0.5rem 1rem;
            margin: 0.5rem;
            font-size: 0.8rem;
            background-color: #e91e63;
            color: #fff;
            border: 2px solid #ffeb3b;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-family: 'Press Start 2P', cursive;
        }
        #auth-form button:hover, #settings-form button:hover, #policies-form button:hover, #withdraw-form button:hover, #reload-form button:hover, #stats-button:hover, #record-button:hover, #send-button:hover, #confirm-reload-modal button:hover {
            background-color: #c2185b;
        }
        #policies-accept:disabled {
            background-color: #616161;
            cursor: not-allowed;
            opacity: 0.6;
        }
        #record-button.recording {
            background-color: #4caf50;
            border-color: #4caf50;
        }
        #auth-toggle {
            color: #03a9f4;
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.7rem;
        }
        #auth-message, #settings-message, #policies-message, #withdraw-message, #reload-message, #chat-message, #confirm-reload-message {
            color: #ffeb3b;
            font-size: 0.7rem;
            margin-top: 0.5rem;
        }
        #verification-instructions {
            background: rgba(3, 169, 244, 0.2);
            padding: 0.5rem;
            border: 2px solid #03a9f4;
            border-radius: 4px;
            margin: 0.5rem 0;
            font-size: 0.7rem;
            color: #ffeb3b;
            display: none;
        }
        #verification-instructions.active {
            display: block;
        }
        #verification-instructions a {
            color: #03a9f4;
            text-decoration: underline;
        }
        #policies-content {
            max-height: 250px;
            overflow-y: auto;
            text-align: left;
            font-size: 0.5rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border: 2px solid #03a9f4;
            background-color: #1a237e;
        }
        #user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.5rem;
            border: 2px solid #ffeb3b;
            border-radius: 4px;
        }
        #user-info p {
            font-size: 0.7rem;
            color: #ffeb3b;
            text-shadow: 0 0 5px #e91e63;
        }
        #pot-display {
            font-size: 1.2rem;
            color: #ffeb3b;
            background: rgba(0, 0, 0, 0.8);
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border: 4px solid #03a9f4;
            border-radius: 8px;
            width: 150px;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            text-shadow: 0 0 8px #e91e63;
            box-shadow: 0 0 10px #03a9f4;
        }
        #last-players {
            display: block;
            width: 100%;
            min-height: 50px;
            max-height: 150px;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.95);
            border: 4px solid #4caf50;
            border-radius: 8px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.7rem;
            color: #ffeb3b;
            text-shadow: 0 0 5px #4caf50;
        }
        #last-players ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #last-players li {
            margin: 0.3rem 0;
        }
        #timer-display {
            font-size: 0.8rem;
            color: #4caf50;
            margin-bottom: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.5rem;
            border: 2px solid #4caf50;
            border-radius: 4px;
        }
        #timer-display p {
            margin-bottom: 0.5rem;
            text-shadow: 0 0 5px #4caf50;
        }
        #progress-bar {
            width: 100%;
            height: 10px;
            background-color: #1a237e;
            border-radius: 5px;
            margin-top: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        #progress-bar-fill {
            height: 100%;
            background-color: #4caf50;
            border-radius: 5px;
            width: 100%;
            transition: width 0.1s linear;
        }
        #timer-percentage {
            margin-top: 0.5rem;
            text-shadow: 0 0 5px #4caf50;
        }
        #compete-button {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            background-color: #e91e63;
            color: #fff;
            border: 2px solid #ffeb3b;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            margin-bottom: 0.5rem;
            font-family: 'Press Start 2P', cursive;
        }
        #compete-button:hover {
            background-color: #c2185b;
        }
        #compete-button:disabled {
            background-color: #616161;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
        }
        #message-box {
            background-color: rgba(0, 0, 0, 0.8);
            color: #ffeb3b;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border: 2px solid #03a9f4;
            border-radius: 4px;
            text-align: center;
            width: 100%;
            max-width: 400px;
            font-size: 0.7rem;
            text-shadow: 0 0 5px #03a9f4;
        }
        .button {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            background-color: #03a9f4;
            color: #fff;
            border: 2px solid #ffeb3b;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            margin: 0.25rem;
            font-family: 'Press Start 2P', cursive;
        }
        .button:hover {
            background-color: #0288d1;
        }
        .button:disabled {
            background-color: #616161;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
        }
        #withdraw-form, #reload-form, #confirm-reload-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: none;
        }
        #withdraw-form.active, #reload-form.active, #confirm-reload-modal.active {
            display: block;
        }
        #policies-status {
            display: flex;
            align-items: center;
            font-size: 0.6rem;
            margin-top: 0.5rem;
        }
        #policies-status input[type="checkbox"] {
            margin-right: 0.5rem;
        }
        #policies-status a {
            color: #03a9f4;
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.6rem;
        }
        #policies-status.accepted {
            color: #4caf50;
        }
        #policies-status.rejected {
            color: #e91e63;
        }
        #chat-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 400px;
            margin-top: 1rem;
        }
        #messages {
            display: block;
            width: 100%;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.95);
            border: 4px solid #4caf50;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .message {
            margin: 0.5rem 0;
            font-size: 0.7rem;
            color: #ffeb3b;
            text-shadow: 0 0 5px #e91e63;
            word-wrap: break-word;
        }
        .message.audio {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #users-list {
            display: block;
            width: 100%;
            min-height: 50px;
            background-color: rgba(0, 0, 0, 0.95);
            border: 4px solid #03a9f4;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.8rem;
            color: #ffeb3b;
            text-shadow: 0 0 5px #03a9f4;
        }
        #users-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #users-list li {
            margin: 0.3rem 0;
        }
        #message-form {
            width: 100%;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        #message-input {
            flex: 1;
            min-width: 150px;
        }
        @media (max-width: 640px) {
            body {
                padding: 5px;
            }
            #game-container, #auth-container, #settings-container, #policies-container, #chat-container {
                margin-top: 0.5rem;
                max-width: 90%;
            }
            #auth-form, #settings-form, #policies-form, #withdraw-form, #reload-form, #chat-container, #confirm-reload-modal {
                padding: 0.5rem;
            }
            #pot-display {
                width: 120px;
                height: 120px;
                font-size: 1rem;
            }
            .button, #compete-button, #stats-button, #record-button, #send-button, #confirm-reload-modal button {
                padding: 0.5rem;
                font-size: 0.7rem;
            }
            #messages, #users-list, #last-players {
                padding: 0.5rem;
            }
            #message-input {
                font-size: 0.6rem;
            }
            .message {
                font-size: 0.6rem;
            }
            #policies-content {
                font-size: 0.4rem;
            }
            #policies-status a {
                font-size: 0.5rem;
            }
            #users-list, #last-players {
                font-size: 0.7rem;
            }
            #verification-instructions {
                font-size: 0.6rem;
            }
        }
    </style>
</head>
<body>
    <div id="auth-container" class="active">
        <div id="auth-form">
            <h2 id="auth-title">Iniciar SesiÃ³n</h2>
            <input type="text" id="auth-username" placeholder="Usuario" required>
            <input type="password" id="auth-password" placeholder="ContraseÃ±a" required>
            <input type="password" id="auth-confirm-password" placeholder="Confirmar ContraseÃ±a" style="display: none;" required>
            <button id="auth-submit">Iniciar SesiÃ³n</button>
            <p id="auth-toggle">Â¿No tienes cuenta? RegÃ­strate</p>
            <p id="auth-message"></p>
            <div id="verification-instructions">
                <p>Â¡EnvÃ­a un mensaje a <a href="https://t.me/Neigbot" target="_blank">@Neigbot</a> en Telegram!</p>
                <p>Escribe: <code id="verification-command"></code></p>
                <p><a id="verification-link" href="#" target="_blank">O haz clic aquÃ­ para enviar el mensaje automÃ¡ticamente</a></p>
            </div>
        </div>
    </div>
    <div id="policies-container">
        <div id="policies-form">
            <h2>PolÃ­ticas y Condiciones</h2>
            <div id="policies-content">
                <p><strong>Ãltima actualizaciÃ³n: 4 de mayo de 2025</strong></p>
                <p>Bienvenido a <strong>La Moneda del Vecindario</strong>, una plataforma de juego competitivo que utiliza Neighborcoin (Neig). Al participar, aceptas estos tÃ©rminos:</p>
                <p><strong>1. AceptaciÃ³n de los TÃ©rminos</strong></p>
                <p>Al hacer clic en "Aceptar", firmas un <strong>contrato de responsabilidad</strong>, aceptando todos los riesgos de participar en el juego. Si eliges "Rechazar", no podrÃ¡s jugar, recargar ni retirar Neig, pero podrÃ¡s usar el chat y observar a otros jugadores.</p>
                <p><strong>2. Naturaleza del Juego</strong></p>
                <p>Cada participaciÃ³n requiere apostar <strong>100 Neig</strong> (equivalente a 100$ en el juego). Puedes perder la totalidad de tu apuesta o ganar una porciÃ³n del pozo (89% al ganador, 5% a desarrolladores, 6% al pozo). <strong>TÃº asumes todo el riesgo</strong> de pÃ©rdida o ganancia.</p>
                <p><strong>3. Consecuencias de tu ElecciÃ³n</strong></p>
                <p>- <strong>Aceptar</strong>: Te permite jugar, recargar Neig, retirar Neig, y participar plenamente en la plataforma.<br>- <strong>Rechazar</strong>: Solo podrÃ¡s usar el chat (enviar mensajes de texto o audio) y ver cÃ³mo juegan otros, sin apostar, recargar, ni retirar.</p>
                <p><strong>4. Responsabilidad del Usuario</strong></p>
                <p>Al aceptar, reconoces que <strong>eres completamente responsable</strong> por cualquier pÃ©rdida de Neig, decisiones financieras, o resultados del juego. La plataforma no ofrece reembolsos ni compensaciones.</p>
                <p><strong>5. Elegibilidad</strong></p>
                <p>Debes ser mayor de 18 aÃ±os y residir en una jurisdicciÃ³n donde el uso de Neig sea legal.</p>
                <p><strong>6. Neighborcoin (Neig)</strong></p>
                <p>Neig es una moneda virtual solo para la plataforma. Retiros (MetaMask o CVU/CBU) pueden tardar 7 dÃ­as, pero requieren aceptar estos tÃ©rminos.</p>
                <p><strong>7. Conducta</strong></p>
                <p>Prohibido usar bots, trampas, o actividades fraudulentas. Podemos suspender cuentas sin reembolsos.</p>
                <p><strong>8. Privacidad</strong></p>
                <p>Recopilamos datos (usuario, MetaMask, CVU/CBU) para retiros y mejoras. No compartimos sin tu consentimiento.</p>
                <p><strong>9. LimitaciÃ³n de Responsabilidad</strong></p>
                <p>La plataforma es "tal cual". No nos responsabilizamos por pÃ©rdidas, errores tÃ©cnicos, o interrupciones.</p>
                <p><strong>10. Modificaciones</strong></p>
                <p>Podemos actualizar estos tÃ©rminos. Tu uso continuado implica aceptaciÃ³n.</p>
                <p><strong>11. Contacto</strong></p>
                <p>ContÃ¡ctanos en <a href="mailto:rod.arena7@gmail.com">rod.arena7@gmail.com</a>.</p>
                <p><strong>12. Aviso Final</strong></p>
                <p>Apostar 100 Neig implica riesgo de pÃ©rdida total. <strong>Al aceptar, firmas este contrato</strong> y juegas bajo tu responsabilidad. Si rechazas, solo podrÃ¡s chatear y observar. Â¡Elige sabiamente!</p>
                <p>Este texto es largo para asegurar que el scrollbar aparezca y que debas desplazarte hasta el final para aceptar o rechazar.</p>
                <p>Gracias por ser parte de La Moneda del Vecindario.</p>
            </div>
            <button id="policies-accept" disabled>Aceptar</button>
            <button id="policies-reject">Rechazar</button>
            <p id="policies-message"></p>
        </div>
    </div>
    <div id="game-container">
        <div id="user-info">
            <p id="username-display">Usuario: </p>
            <p id="coins-display">Saldo: 1000 Neig</p>
        </div>
        <button id="stats-button">EstadÃ­sticas</button>
        <div id="pot-display">Pozo: 0 Neig</div>
        <div id="last-players">Ãltimo Jugador: Ninguno</div>
        <div id="timer-display">
            <p>Tiempo Restante: 4:00</p>
            <div id="progress-bar">
                <div id="progress-bar-fill"></div>
            </div>
            <p id="timer-percentage">100%</p>
        </div>
        <button id="compete-button">Jugar (100 Neig)</button>
        <div id="message-box">Bienvenido al juego. Â¡Presiona el botÃ³n para competir!</div>
        <div class="flex flex-wrap justify-center gap-2">
            <button id="reload-button" class="button">Recargar Neig</button>
            <button id="withdraw-button" class="button">Retirar Neig</button>
            <button id="settings-button" class="button">ConfiguraciÃ³n</button>
            <button id="logout-button" class="button">Cerrar SesiÃ³n</button>
        </div>
        <div id="policies-status" class="rejected">
            <input type="checkbox" id="policies-checkbox" disabled>
            <span id="policies-text">Ud. no aceptÃ³ las </span>
            <a id="policies-link" href="javascript:void(0)">PolÃ­ticas y Condiciones</a>
        </div>
        <div id="chat-container">
            <div id="users-list">Usuarios conectados: 0</div>
            <div id="messages"></div>
            <form id="message-form">
                <input type="text" id="message-input" placeholder="Escribe un mensaje">
                <button type="button" id="record-button">Grabar Audio</button>
                <button type="submit" id="send-button">Enviar</button>
                <p id="chat-message"></p>
            </form>
        </div>
    </div>
    <div id="settings-container">
        <div id="settings-form">
            <h2>ConfiguraciÃ³n</h2>
            <input type="text" id="settings-display-name" placeholder="Nombre ficticio">
            <input type="text" id="settings-cvu" placeholder="CVU/CBU o Alias">
            <input type="text" id="settings-metamask" placeholder="DirecciÃ³n MetaMask">
            <button id="settings-save">Guardar</button>
            <button id="settings-back">Volver</button>
            <p id="settings-message"></p>
        </div>
    </div>
    <div id="withdraw-form">
        <h2>Retirar Neig</h2>
        <input type="number" id="withdraw-amount" placeholder="Cantidad a retirar" min="1" required>
        <select id="withdraw-currency">
            <option value="Neig">Neig</option>
            <option value="Pesos">Pesos</option>
        </select>
        <button id="withdraw-submit">Confirmar Retiro</button>
        <button id="withdraw-cancel">Cancelar</button>
        <p id="withdraw-message"></p>
    </div>
    <div id="reload-form">
        <h2>Recargar Neig</h2>
        <input type="number" id="reload-amount" placeholder="Cantidad a recargar (ARS)" min="1" required>
        <button id="reload-submit">Confirmar</button>
        <button id="reload-cancel">Cancelar</button>
        <p id="reload-message"></p>
    </div>
    <div id="confirm-reload-modal">
        <h2>Confirmar Recarga</h2>
        <p>Â¿EstÃ¡s seguro de recargar <span id="confirm-amount"></span> Neig?</p>
        <button id="confirm-reload-submit">Confirmar</button>
        <button id="confirm-reload-cancel">Cancelar</button>
        <p id="confirm-reload-message"></p>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4.4.1/dist/email.min.js" onerror="showErrorMessage('auth-message', 'Error al cargar EmailJS. Verifica tu conexiÃ³n.')"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar EmailJS
            try {
                if (typeof emailjs !== 'undefined') {
                    emailjs.init("KWVSgPsdHmSAURvGd");
                } else {
                    showErrorMessage('auth-message', 'EmailJS no estÃ¡ disponible. Verifica tu conexiÃ³n.');
                }
            } catch (error) {
                console.error('Error al inicializar EmailJS:', error);
                showErrorMessage('auth-message', 'Error al cargar EmailJS. Verifica tu conexiÃ³n.');
            }

            // PWA Setup
            let deferredPrompt = null;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
            });
            window.addEventListener('appinstalled', () => {
                showErrorMessage('message-box', 'Â¡La Moneda del Vecindario ha sido instalada!');
                deferredPrompt = null;
            });

            // Registrar Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(error => {
                    console.error('Error al registrar Service Worker:', error);
                });
            }

            // ConfiguraciÃ³n inicial
            const POLICIES_VERSION = "1.3.0";
            let playerCoins = 1000;
            let hasParticipated = false;
            let username = null;
            let sessionId = null;
            let lastPlayer = null;
            const developerPercentage = 0.05;
            const potPercentage = 0.06;

            // Elementos del DOM
            const authContainer = document.getElementById('auth-container');
            const gameContainer = document.getElementById('game-container');
            const settingsContainer = document.getElementById('settings-container');
            const policiesContainer = document.getElementById('policies-container');
            const withdrawForm = document.getElementById('withdraw-form');
            const reloadForm = document.getElementById('reload-form');
            const confirmReloadModal = document.getElementById('confirm-reload-modal');
            const authTitle = document.getElementById('auth-title');
            const authUsername = document.getElementById('auth-username');
            const authPassword = document.getElementById('auth-password');
            const authConfirmPassword = document.getElementById('auth-confirm-password');
            const authSubmit = document.getElementById('auth-submit');
            const authToggle = document.getElementById('auth-toggle');
            const authMessage = document.getElementById('auth-message');
            const verificationInstructions = document.getElementById('verification-instructions');
            const verificationCommand = document.getElementById('verification-command');
            const verificationLink = document.getElementById('verification-link');
            const statsButton = document.getElementById('stats-button');
            const potDisplay = document.getElementById('pot-display');
            const lastPlayersDisplay = document.getElementById('last-players');
            const timerDisplay = document.getElementById('timer-display');
            const competeButton = document.getElementById('compete-button');
            const messageBox = document.getElementById('message-box');
            const reloadButton = document.getElementById('reload-button');
            const withdrawButton = document.getElementById('withdraw-button');
            const settingsButton = document.getElementById('settings-button');
            const logoutButton = document.getElementById('logout-button');
            const usernameDisplay = document.getElementById('username-display');
            const coinsDisplay = document.getElementById('coins-display');
            const progressBarFill = document.getElementById('progress-bar-fill');
            const timerPercentageDisplay = document.getElementById('timer-percentage');
            const settingsDisplayName = document.getElementById('settings-display-name');
            const settingsCvu = document.getElementById('settings-cvu');
            const settingsMetamask = document.getElementById('settings-metamask');
            const settingsSave = document.getElementById('settings-save');
            const settingsBack = document.getElementById('settings-back');
            const withdrawAmount = document.getElementById('withdraw-amount');
            const withdrawCurrency = document.getElementById('withdraw-currency');
            const withdrawSubmit = document.getElementById('withdraw-submit');
            const withdrawCancel = document.getElementById('withdraw-cancel');
            const withdrawMessage = document.getElementById('withdraw-message');
            const reloadAmount = document.getElementById('reload-amount');
            const reloadSubmit = document.getElementById('reload-submit');
            const reloadCancel = document.getElementById('reload-cancel');
            const reloadMessage = document.getElementById('reload-message');
            const confirmAmount = document.getElementById('confirm-amount');
            const confirmReloadSubmit = document.getElementById('confirm-reload-submit');
            const confirmReloadCancel = document.getElementById('confirm-reload-cancel');
            const confirmReloadMessage = document.getElementById('confirm-reload-message');
            const policiesAccept = document.getElementById('policies-accept');
            const policiesReject = document.getElementById('policies-reject');
            const policiesMessage = document.getElementById('policies-message');
            const policiesContent = document.getElementById('policies-content');
            const policiesStatus = document.getElementById('policies-status');
            const policiesCheckbox = document.getElementById('policies-checkbox');
            const policiesText = document.getElementById('policies-text');
            const policiesLink = document.getElementById('policies-link');
            const messages = document.getElementById('messages');
            const messageInput = document.getElementById('message-input');
            const recordButton = document.getElementById('record-button');
            const sendButton = document.getElementById('send-button');
            const messageForm = document.getElementById('message-form');
            const usersList = document.getElementById('users-list');
            const chatMessage = document.getElementById('chat-message');

            // Estado de autenticaciÃ³n
            let isLoginMode = true;

            // PolÃ­ticas en HTML
            const policiesHtml = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolÃ­ticas y Condiciones - La Moneda del Vecindario</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background: url('/images/background.jpg') no-repeat center center fixed;
            background-size: cover;
            background-color: #000;
            color: #fff;
            margin: 20px;
            padding: 20px;
            box-sizing: border-box;
            image-rendering: pixelated;
        }
        .container {
            background-color: rgba(0, 0, 0, 0.9);
            padding: 2rem;
            border: 4px solid #ffeb3b;
            border-radius: 8px;
            box-shadow: 0 0 10px #ffeb3b, 0 0 20px #e91e63;
            max-width: 800px;
            margin: 0 auto;
            text-align: left;
            font-size: 0.7rem;
        }
        h1 {
            color: #ffeb3b;
            text-shadow: 0 0 8px #e91e63;
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        h2 {
            color: #03a9f4;
            font-size: 0.9rem;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        p {
            line-height: 1.6;
            margin-bottom: 1rem;
            color: #fff;
            text-shadow: 0 0 5px #03a9f4;
        }
        ul {
            list-style: none;
            padding: 0;
            margin-bottom: 1rem;
        }
        li {
            margin-bottom: 0.5rem;
            position: relative;
            padding-left: 1.5rem;
        }
        li:before {
            content: 'â¤';
            color: #4caf50;
            position: absolute;
            left: 0;
        }
        a {
            color: #03a9f4;
            text-decoration: underline;
            cursor: pointer;
        }
        a:hover {
            color: #0288d1;
        }
        .highlight {
            color: #ffeb3b;
            font-weight: bold;
        }
        @media (max-width: 640px) {
            body {
                padding: 10px;
                margin: 10px;
            }
            .container {
                padding: 1rem;
                font-size: 0.6rem;
            }
            h1 {
                font-size: 1rem;
            }
            h2 {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PolÃ­ticas, TÃ©rminos y Condiciones</h1>
        <p><strong>Ãltima actualizaciÃ³n: 4 de mayo de 2025</strong></p>
        <p>Bienvenido a <strong>La Moneda del Vecindario</strong>, una plataforma de juego competitivo que utiliza Neighborcoin (Neig) como moneda virtual. Al participar, aceptas los siguientes tÃ©rminos y condiciones, que rigen tu uso del juego y delegan toda la responsabilidad de tus decisiones a ti, el usuario.</p>
        <h2>1. AceptaciÃ³n de los TÃ©rminos</h2>
        <p>Al hacer clic en "Aceptar", <span class="highlight">firmas un contrato de responsabilidad</span>, aceptando todos los riesgos asociados con el juego, incluyendo la posible pÃ©rdida de Neighborcoin (Neig). Si eliges "Rechazar", no podrÃ¡s jugar, recargar ni retirar Neig, pero podrÃ¡s participar en el chat y observar a otros jugadores.</p>
        <h2>2. Naturaleza del Juego y Apuestas</h2>
        <p>La Moneda del Vecindario es un juego competitivo donde apuestas <span class="highlight">100 Neig</span> (equivalente a 100$ en el contexto del juego) por ronda. Los resultados son inciertos, y puedes <span class="highlight">perder la totalidad de tu apuesta</span> o ganar una porciÃ³n del pozo.</p>
        <ul>
            <li><strong>Apuesta Fija</strong>: Cada ronda requiere apostar exactamente 100 Neig. No hay excepciones.</li>
            <li><strong>Riesgo</strong>: Aceptas que puedes perder los 100 Neig apostados sin garantÃ­a de ganancia.</li>
            <li><strong>DistribuciÃ³n del Pozo</strong>: El pozo se distribuye asÃ­: 89% al ganador, 5% a los desarrolladores, 6% al pozo siguiente.</li>
        </ul>
        <h2>3. Consecuencias de tu ElecciÃ³n</h2>
        <p>Tu decisiÃ³n de aceptar o rechazar estos tÃ©rminos determina tu acceso a la plataforma:</p>
        <ul>
            <li><strong>Aceptar</strong>: Te permite jugar (apostar 100 Neig por ronda), recargar Neig, retirar Neig, y participar plenamente en todas las funciones de la plataforma.</li>
            <li><strong>Rechazar</strong>: Solo podrÃ¡s usar el chat (enviar mensajes de texto o audio) y observar el juego (ver el pozo, temporizador, y Ãºltimos jugadores). No podrÃ¡s apostar, recargar, ni retirar Neig.</li>
        </ul>
        <h2>4. Responsabilidad del Usuario</h2>
        <p>Al aceptar, <span class="highlight">tÃº asumes toda la responsabilidad</span> por:</p>
        <ul>
            <li>PÃ©rdidas de Neig debido a apuestas.</li>
            <li>Decisiones financieras o personales derivadas de tu participaciÃ³n.</li>
            <li>Resultados del juego, que no garantizan ganancias.</li>
        </ul>
        <p>La plataforma no ofrece reembolsos ni compensaciones por pÃ©rdidas. Juega solo con Neig que estÃ©s dispuesto a perder.</p>
        <h2>5. Elegibilidad</h2>
        <p>Debes:</p>
        <ul>
            <li>Ser mayor de 18 aÃ±os.</li>
            <li>Residir en una jurisdicciÃ³n donde el uso de Neig sea legal.</li>
            <li>Cumplir con las leyes locales. Es tu responsabilidad verificar la legalidad.</li>
        </ul>
        <h2>6. Neighborcoin (Neig)</h2>
        <p>Neig es una moneda virtual exclusiva de la plataforma, usada para apuestas y retiros. No tiene valor fuera de La Moneda del Vecindario.</p>
        <ul>
            <li><strong>Retiros</strong>: Requieren aceptar estos tÃ©rminos y una direcciÃ³n MetaMask o CVU/CBU. Pueden tardar 7 dÃ­as.</li>
            <li><strong>Recargas</strong>: Solo disponibles si aceptas los tÃ©rminos.</li>
        </ul>
        <h2>7. Conducta del Usuario</h2>
        <p>Prohibimos:</p>
        <ul>
            <li>Usar bots, scripts, o trampas.</li>
            <li>Actividades fraudulentas.</li>
            <li>Comprometer la integridad del juego.</li>
        </ul>
        <p>Podemos suspender cuentas sin reembolsos por violaciones.</p>
        <h2>8. Privacidad</h2>
        <p>Recopilamos datos (usuario, MetaMask, CVU/CBU) para retiros y mejoras. No compartimos datos sin tu consentimiento, salvo requerimiento legal.</p>
        <h2>9. LimitaciÃ³n de Responsabilidad</h2>
        <p>La plataforma es <span class="highlight">"tal cual"</span>. No nos responsabilizamos por:</p>
        <ul>
            <li>PÃ©rdidas de Neig.</li>
            <li>Errores tÃ©cnicos o interrupciones.</li>
            <li>DaÃ±os derivados de tu uso.</li>
        </ul>
        <h2>10. Modificaciones</h2>
        <p>Podemos actualizar estos tÃ©rminos. Las actualizaciones se notificarÃ¡n, y tu uso continuado implica aceptaciÃ³n.</p>
        <h2>11. TerminaciÃ³n</h2>
        <p>Podemos suspender o terminar tu acceso por violaciones, sin reembolsos.</p>
        <h2>12. Contacto</h2>
        <p>ContÃ¡ctanos en <a href="mailto:rod.arena7@gmail.com">rod.arena7@gmail.com</a>.</p>
        <h2>13. Aviso Final</h2>
        <p>Al aceptar, <span class="highlight">firmas este contrato</span> y reconoces que apostar 100 Neig implica riesgo de pÃ©rdida total. Si rechazas, solo podrÃ¡s chatear y observar. Juega responsablemente. Â¡Gracias por unirte a La Moneda del Vecindario!</p>
    </div>
</body>
</html>`;

            // EstadÃ­sticas en HTML
            const statsHtml = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EstadÃ­sticas - La Moneda del Vecindario</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background: url('/images/background.jpg') no-repeat center center fixed;
            background-size: cover;
            background-color: #000;
            color: #fff;
            margin: 20px;
            padding: 20px;
            box-sizing: border-box;
            image-rendering: pixelated;
        }
        .container {
            background-color: rgba(0, 0, 0, 0.9);
            padding: 2rem;
            border: 4px solid #ffeb3b;
            border-radius: 8px;
            box-shadow: 0 0 10px #ffeb3b, 0 0 20px #e91e63;
            max-width: 800px;
            margin: 0 auto;
            text-align: left;
            font-size: 0.7rem;
        }
        h1 {
            color: #ffeb3b;
            text-shadow: 0 0 8px #e91e63;
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        h2 {
            color: #03a9f4;
            font-size: 0.9rem;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        th, td {
            border: 1px solid #ffeb3b;
            padding: 0.5rem;
            text-align: left;
        }
        th {
            background-color: #03a9f4;
            color: #fff;
        }
        td {
            color: #fff;
        }
        .back-button {
            background: #ff6200;
            color: #fff;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem;
            display: block;
            margin: 1rem auto;
        }
        .back-button:hover {
            background: #e91e63;
        }
        @media (max-width: 640px) {
            body {
                padding: 10px;
                margin: 10px;
            }
            .container {
                padding: 1rem;
                font-size: 0.6rem;
            }
            h1 {
                font-size: 1rem;
            }
            h2 {
                font-size: 0.8rem;
            }
            .back-button {
                font-size: 0.6rem;
                padding: 0.4rem 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>EstadÃ­sticas del Juego</h1>
        <h2>Ãltimos Ganadores</h2>
        <table id="winners-table">
            <tr><th>Usuario</th><th>Fecha</th><th>Monto</th></tr>
        </table>
        <h2>Usuarios con MÃ¡s Victorias</h2>
        <table id="top-winners-table">
            <tr><th>Usuario</th><th>Victorias</th></tr>
        </table>
        <h2>Usuarios con MÃ¡s Clics</h2>
        <table id="clicks-table">
            <tr><th>Usuario</th><th>Clics</th></tr>
        </table>
        <h2>Total Apostado</h2>
        <table id="bets-table">
            <tr><th>Usuario</th><th>Total Apostado (Neig)</th></tr>
        </table>
        <h2>PÃ©rdidas por Jugador</h2>
        <table id="losses-table">
            <tr><th>Usuario</th><th>PÃ©rdidas (Neig)</th></tr>
        </table>
        <button class="back-button" onclick="window.close()">Volver</button>
    </div>
    <script>
        fetch('https://neigame.onrender.com/stats')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Ãltimos Ganadores
                    const winnersTable = document.getElementById('winners-table');
                    data.winners.forEach(winner => {
                        const row = winnersTable.insertRow();
                        row.insertCell().textContent = winner.username;
                        row.insertCell().textContent = winner.timestamp;
                        row.insertCell().textContent = winner.amount + ' Neig';
                    });
                    // MÃ¡s Ganadores
                    const topWinnersTable = document.getElementById('top-winners-table');
                    for (const [user, wins] of Object.entries(data.topWinners)) {
                        const row = topWinnersTable.insertRow();
                        row.insertCell().textContent = user;
                        row.insertCell().textContent = wins;
                    }
                    // MÃ¡s Clics
                    const clicksTable = document.getElementById('clicks-table');
                    for (const [user, clicks] of Object.entries(data.clicks)) {
                        const row = clicksTable.insertRow();
                        row.insertCell().textContent = user;
                        row.insertCell().textContent = clicks;
                    }
                    // Total Apostado
                    const betsTable = document.getElementById('bets-table');
                    for (const [user, total] of Object.entries(data.totalBets)) {
                        const row = betsTable.insertRow();
                        row.insertCell().textContent = user;
                        row.insertCell().textContent = total + ' Neig';
                    }
                    // PÃ©rdidas
                    const lossesTable = document.getElementById('losses-table');
                    for (const [user, losses] of Object.entries(data.losses)) {
                        const row = lossesTable.insertRow();
                        row.insertCell().textContent = user;
                        row.insertCell().textContent = losses + ' Neig';
                    }
                } else {
                    document.body.innerHTML = '<div class="container"><h1>Error al cargar estadÃ­sticas</h1></div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.body.innerHTML = '<div class="container"><h1>Error al conectar con el servidor</h1></div>';
            });
    </script>
</body>
</html>`;

            // ConfiguraciÃ³n del chat
            const socket = io('https://neigame.onrender.com', {
                transports: ['websocket', 'polling'],
                reconnectionAttempts: 5,
                path: '/socket.io'
            });
            let mediaRecorder = null;

            // Habilitar botÃ³n Aceptar al llegar al final de polÃ­ticas
            policiesContent.addEventListener('scroll', () => {
                const isAtBottom = policiesContent.scrollHeight - policiesContent.scrollTop <= policiesContent.clientHeight + 1;
                policiesAccept.disabled = !isAtBottom;
            });

            // Mostrar instrucciones de verificaciÃ³n
            function showVerificationInstructions(username) {
                verificationCommand.textContent = `/start ${username}`;
                verificationLink.href = `https://t.me/Neigbot?text=/start%20${username}`;
                verificationInstructions.classList.add('active');
                setTimeout(() => {
                    verificationInstructions.classList.remove('active');
                    verificationCommand.textContent = '';
                    verificationLink.href = '#';
                }, 15000);
            }

            function showChatMessage(message) {
                chatMessage.textContent = message;
                setTimeout(() => chatMessage.textContent = '', 3000);
            }

            function addMessage({ user, content, type = 'text' }) {
                try {
                    console.log(`AÃ±adiendo mensaje: ${user} - ${type} - ${content.substring(0, 50)}...`);
                    const div = document.createElement('div');
                    div.className = `message ${type}`;
                    if (type === 'text') {
                        div.textContent = `${user}: ${content}`;
                    } else if (type === 'audio') {
                        const audio = document.createElement('audio');
                        audio.controls = true;
                        audio.src = content;
                        div.textContent = `${user}: `;
                        div.appendChild(audio);
                    }
                    messages.appendChild(div);
                    messages.scrollTop = messages.scrollHeight;
                } catch (error) {
                    console.error('Error al aÃ±adir mensaje:', error);
                    showChatMessage('Error al mostrar mensaje.');
                }
            }

            function updateUsersList(users) {
                try {
                    console.log('Actualizando lista de usuarios:', users);
                    usersList.innerHTML = `<strong>Usuarios conectados: ${users.length}</strong>`;
                    if (users.length === 0) {
                        const p = document.createElement('p');
                        p.textContent = 'No hay usuarios conectados';
                        usersList.appendChild(p);
                    } else {
                        const ul = document.createElement('ul');
                        users.forEach(user => {
                            const li = document.createElement('li');
                            li.textContent = user;
                            ul.appendChild(li);
                        });
                        usersList.appendChild(ul);
                    }
                } catch (error) {
                    console.error('Error al actualizar lista de usuarios:', error);
                    showChatMessage('Error al actualizar lista de usuarios.');
                }
            }

            function updateLastPlayers() {
                try {
                    console.log('Actualizando Ãºltimo jugador:', lastPlayer);
                    lastPlayersDisplay.innerHTML = '<strong>Ãltimo Jugador:</strong>';
                    if (lastPlayer) {
                        const p = document.createElement('p');
                        p.textContent = lastPlayer;
                        lastPlayersDisplay.appendChild(p);
                    } else {
                        const p = document.createElement('p');
                        p.textContent = 'Ninguno';
                        lastPlayersDisplay.appendChild(p);
                    }
                } catch (error) {
                    console.error('Error al actualizar Ãºltimo jugador:', error);
                    showErrorMessage('message-box', 'Error al actualizar Ãºltimo jugador.');
                }
            }

            function updateTimerDisplay(seconds, pot, lastPlayerServer) {
                try {
                    lastPlayer = lastPlayerServer;
                    potDisplay.textContent = `Pozo: ${pot} Neig`;
                    const minutes = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    const percentage = Math.max(0, (seconds / 240) * 100);
                    timerDisplay.querySelector('p').textContent = `Tiempo Restante: ${minutes}:${secs < 10 ? '0' : ''}${secs}`;
                    progressBarFill.style.width = `${percentage}%`;
                    timerPercentageDisplay.textContent = `${Math.round(percentage)}%`;
                    if (seconds <= 0 && lastPlayer) {
                        const playerWinAmount = Math.round(pot * 0.89);
                        addMessage({
                            user: 'Sistema',
                            content: `Â¡${lastPlayer} ganÃ³ ${playerWinAmount} Neig!`,
                            type: 'text'
                        });
                        if (lastPlayer === username) {
                            playerCoins += playerWinAmount;
                            updateUserCoins(username, playerCoins);
                            updatePlayerInfo();
                        }
                        lastPlayer = null;
                        hasParticipated = false;
                        competeButton.disabled = false;
                        competeButton.textContent = 'Jugar (100 Neig)';
                    }
                    updateLastPlayers();
                } catch (error) {
                    console.error('Error al actualizar temporizador:', error);
                    showErrorMessage('message-box', 'Error al actualizar temporizador.');
                }
            }

            // Inicializar chat con mensaje de sistema
            function initializeChat() {
                addMessage({ user: 'Sistema', content: 'Chat iniciado. Â¡Bienvenido!', type: 'text' });
            }

            socket.on('connect', () => {
                console.log('Conectado al servidor Socket.IO');
                if (username) {
                    socket.emit('join', username);
                }
            });

            socket.on('connect_error', (error) => {
                console.error('Error de conexiÃ³n Socket.IO:', error);
                showChatMessage('Error al conectar al servidor de chat.');
            });

            socket.on('chat message', ({ user, message, type }) => {
                console.log(`Mensaje recibido: ${user} - ${type}`);
                addMessage({ user, content: message, type });
            });

            socket.on('users update', (users) => {
                console.log('Lista de usuarios recibida:', users);
                updateUsersList(users);
            });

            socket.on('user joined', ({ user }) => {
                console.log(`Usuario unido: ${user}`);
                addMessage({ user: 'Sistema', content: `${user} se ha unido al chat`, type: 'text' });
            });

            socket.on('user left', ({ user }) => {
                console.log(`Usuario desconectado: ${user}`);
                addMessage({ user: 'Sistema', content: `${user} ha abandonado el chat`, type: 'text' });
            });

            socket.on('timer update', ({ seconds, pot, lastPlayer }) => {
                console.log(`ActualizaciÃ³n del temporizador: ${seconds}, Pozo: ${pot}, Ãltimo jugador: ${lastPlayer}`);
                updateTimerDisplay(seconds, pot, lastPlayer);
            });

            socket.on('coins update', ({ username: updatedUsername, coins, message }) => {
                if (username === updatedUsername) {
                    playerCoins = coins;
                    updatePlayerInfo();
                    if (message) {
                        showMessage(message);
                    }
                }
            });

            messageForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const message = messageInput.value.trim().toLowerCase();
                if (message && username) {
                    if (message === 'descargar' || message === 'cerrar') {
                        if (deferredPrompt) {
                            deferredPrompt.prompt();
                            deferredPrompt.userChoice.then(choiceResult => {
                                if (choiceResult.outcome === 'accepted') {
                                    showErrorMessage('message-box', 'Instalando La Moneda del Vecindario...');
                                } else {
                                    showErrorMessage('message-box', 'InstalaciÃ³n cancelada.');
                                }
                                deferredPrompt = null;
                            });
                        } else {
                            showErrorMessage('message-box', 'La instalaciÃ³n no estÃ¡ disponible en este navegador.');
                        }
                        messageInput.value = '';
                    } else {
                        console.log(`Enviando mensaje de texto: ${message}`);
                        socket.emit('chat message', { user: username, message, type: 'text' });
                        messageInput.value = '';
                    }
                } else {
                    showChatMessage('Inicia sesiÃ³n para enviar mensajes.');
                }
            });

            recordButton.addEventListener('click', async () => {
                if (!username) {
                    showChatMessage('Inicia sesiÃ³n para grabar audio.');
                    return;
                }
                if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        const chunks = [];
                        mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
                        mediaRecorder.onstop = () => {
                            const blob = new Blob(chunks, { type: 'audio/webm' });
                            const reader = new FileReader();
                            reader.onload = () => {
                                console.log('Enviando mensaje de audio');
                                socket.emit('chat message', {
                                    user: username,
                                    message: reader.result,
                                    type: 'audio'
                                });
                            };
                            reader.readAsDataURL(blob);
                        };
                        mediaRecorder.start();
                        recordButton.textContent = 'Detener GrabaciÃ³n';
                        recordButton.classList.add('recording');
                    } catch (error) {
                        console.error('Error al acceder al micrÃ³fono:', error);
                        showChatMessage('Error al acceder al micrÃ³fono.');
                    }
                } else {
                    mediaRecorder.stop();
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    recordButton.textContent = 'Grabar Audio';
                    recordButton.classList.remove('recording');
                }
            });

            // Funciones de mensajes
            function showAuthMessage(message, isSuccess = false) {
                authMessage.textContent = message;
                authMessage.style.color = isSuccess ? '#4caf50' : '#ffeb3b';
                setTimeout(() => authMessage.textContent = '', 10000);
            }

            function showMessage(message) {
                messageBox.textContent = message;
                while (messageBox.childNodes.length > 1) {
                    messageBox.removeChild(messageBox.lastChild);
                }
            }

            function showPoliciesMessage(message) {
                policiesMessage.textContent = message;
            }

            function showSettingsMessage(message) {
                settingsMessage.textContent = message;
            }

            function showWithdrawMessage(message) {
                withdrawMessage.textContent = message;
            }

            function showReloadMessage(message) {
                reloadMessage.textContent = message;
            }

            function showConfirmReloadMessage(message) {
                confirmReloadMessage.textContent = message;
            }

            // Funciones de autenticaciÃ³n
            async function handleAuthSubmit() {
                const usernameInput = authUsername.value.trim();
                const passwordInput = authPassword.value.trim();
                const confirmPasswordInput = authConfirmPassword.value.trim();

                if (!usernameInput || !passwordInput) {
                    showAuthMessage('Por favor, completa todos los campos.');
                    return;
                }

                if (!isLoginMode && passwordInput !== confirmPasswordInput) {
                    showAuthMessage('Las contraseÃ±as no coinciden.');
                    return;
                }

                const endpoint = isLoginMode ? '/login' : '/register';
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: usernameInput, password: passwordInput })
                    });

                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await response.text();
                        console.error('Respuesta no es JSON:', text);
                        showAuthMessage(`Error del servidor: Respuesta no vÃ¡lida (recibido HTML o texto)`);
                        return;
                    }

                    const result = await response.json();
                    if (result.success || result.message) {
                        username = usernameInput;
                        if (isLoginMode) {
                            sessionId = result.sessionId;
                            authContainer.classList.remove('active');
                            if (result.policiesAccepted && result.policiesVersion === POLICIES_VERSION && result.telegramVerified) {
                                gameContainer.classList.add('active');
                                initializeGame();
                            } else if (!result.telegramVerified) {
                                showVerificationInstructions(usernameInput);
                                showAuthMessage(`Debes verificar tu cuenta enviando /start ${usernameInput} a @NeigBot en Telegram.`);
                                setTimeout(() => {
                                    authContainer.classList.add('active');
                                }, 3000);
                            } else {
                                policiesContainer.classList.add('active');
                            }
                        } else {
                            showAuthMessage(`Registro exitoso. Verifica tu cuenta enviando /start ${usernameInput} a @NeigBot en Telegram.`, true);
                            showVerificationInstructions(usernameInput);
                            setTimeout(() => {
                                toggleAuthMode();
                                authContainer.classList.add('active');
                            }, 15000);
                        }
                    } else {
                        showAuthMessage(result.detail || (isLoginMode ? 'Usuario o contraseÃ±a incorrectos.' : 'El usuario ya existe.'));
                    }
                } catch (error) {
                    console.error('Error en autenticaciÃ³n:', error);
                    showAuthMessage(`Error al conectar con el servidor: ${error.message}`);
                }
            }

            function toggleAuthMode() {
                isLoginMode = !isLoginMode;
                authTitle.textContent = isLoginMode ? 'Iniciar SesiÃ³n' : 'Registrarse';
                authSubmit.textContent = isLoginMode ? 'Iniciar SesiÃ³n' : 'Registrarse';
                authToggle.textContent = isLoginMode ? 'Â¿No tienes cuenta? RegÃ­strate' : 'Â¿Ya tienes cuenta? Inicia sesiÃ³n';
                authConfirmPassword.style.display = isLoginMode ? 'none' : 'block';
                showAuthMessage('');
                authUsername.value = '';
                authPassword.value = '';
                authConfirmPassword.value = '';
                verificationInstructions.classList.remove('active');
            }

            // Funciones de polÃ­ticas
            async function handlePoliciesAccept() {
                try {
                    const response = await fetch('/accept-policies', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, policiesVersion: POLICIES_VERSION })
                    });

                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await response.text();
                        console.error('Respuesta no es JSON:', text);
                        showPoliciesMessage('Error del servidor: Respuesta no vÃ¡lida');
                        return;
                    }

                    const result = await response.json();
                    if (result.success) {
                        policiesContainer.classList.remove('active');
                        gameContainer.classList.add('active');
                        initializeGame();
                        showMessage('Has aceptado las PolÃ­ticas y Condiciones. Â¡Bienvenido al juego!');
                    } else {
                        showPoliciesMessage(result.detail || 'Error al aceptar las polÃ­ticas.');
                    }
                } catch (error) {
                    console.error('Error al aceptar polÃ­ticas:', error);
                    showPoliciesMessage(`Error al conectar con el servidor: ${error.message}`);
                }
            }

            async function handlePoliciesReject() {
                try {
                    const response = await fetch('/reject-policies', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, policiesVersion: POLICIES_VERSION })
                    });

                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await response.text();
                        console.error('Respuesta no es JSON:', text);
                        showPoliciesMessage('Error del servidor: Respuesta no vÃ¡lida');
                        return;
                    }

                    const result = await response.json();
                    if (result.success) {
                        policiesContainer.classList.remove('active');
                        gameContainer.classList.add('active');
                        initializeGame();
                        showMessage('Has rechazado las PolÃ­ticas y Condiciones. Solo puedes usar el chat y observar el juego.');
                    } else {
                        showPoliciesMessage(result.detail || 'Error al rechazar las polÃ­ticas.');
                    }
                } catch (error) {
                    console.error('Error al rechazar polÃ­ticas:', error);
                    showPoliciesMessage(`Error al conectar con el servidor: ${error.message}`);
                }
            }

            function updatePoliciesStatus() {
                fetch(`/user/${username}`)
                    .then(response => response.json())
                    .then(user => {
                        if (user && user.policiesAccepted && user.policiesVersion === POLICIES_VERSION) {
                            policiesStatus.classList.remove('rejected');
                            policiesStatus.classList.add('accepted');
                            policiesCheckbox.checked = true;
                            policiesText.textContent = 'Ud. aceptÃ³ las ';
                        } else {
                            policiesStatus.classList.remove('accepted');
                            policiesStatus.classList.add('rejected');
                            policiesCheckbox.checked = false;
                            policiesText.textContent = 'Ud. no aceptÃ³ las ';
                        }
                    })
                    .catch(error => {
                        console.error('Error al actualizar estado de polÃ­ticas:', error);
                    });
            }

            function showPoliciesWindow() {
                try {
                    const policiesWindow = window.open('', '_blank');
                    if (policiesWindow) {
                        policiesWindow.document.write(policiesHtml);
                        policiesWindow.document.close();
                    } else {
                        showMessage('No se pudo abrir la ventana de polÃ­ticas. Desactiva el bloqueador de ventanas emergentes.');
                        const dataUrl = 'data:text/html;charset=utf-8,' + encodeURIComponent(policiesHtml);
                        const link = document.createElement('a');
                        link.href = dataUrl;
                        link.download = 'politicas_y_condiciones.html';
                        link.textContent = 'Descargar PolÃ­ticas';
                        link.style.color = '#03a9f4';
                        link.style.textDecoration = 'underline';
                        link.style.fontSize = '0.7rem';
                        messageBox.appendChild(document.createElement('br'));
                        messageBox.appendChild(link);
                    }
                } catch (error) {
                    console.error('Error al mostrar ventana de polÃ­ticas:', error);
                    showMessage('Error al mostrar polÃ­ticas.');
                }
            }

            // Funciones de estadÃ­sticas
            function showStatsWindow() {
                try {
                    const statsWindow = window.open('', '_blank');
                    if (statsWindow) {
                        statsWindow.document.write(statsHtml);
                        statsWindow.document.close();
                    } else {
                        showMessage('No se pudo abrir la ventana de estadÃ­sticas. Desactiva el bloqueador de ventanas emergentes.');
                        const dataUrl = 'data:text/html;charset=utf-8,' + encodeURIComponent(statsHtml);
                        const link = document.createElement('a');
                        link.href = dataUrl;
                        link.download = 'estadisticas_juego.html';
                        link.textContent = 'Descargar EstadÃ­sticas';
                        link.style.color = '#03a9f4';
                        link.style.textDecoration = 'underline';
                        link.style.fontSize = '0.7rem';
                        messageBox.appendChild(document.createElement('br'));
                        messageBox.appendChild(link);
                    }
                } catch (error) {
                    console.error('Error al mostrar estadÃ­sticas:', error);
                    showMessage('Error al cargar estadÃ­sticas.');
                }
            }

            // Funciones de configuraciÃ³n
            function loadUserSettings() {
                fetch(`/user/${username}`)
                    .then(response => response.json())
                    .then(user => {
                        if (user && user.settings) {
                            settingsDisplayName.value = user.settings.displayName || '';
                            settingsCvu.value = user.settings.cvu || '';
                            settingsMetamask.value = user.settings.metamask || '';
                        }
                    })
                    .catch(error => {
                        console.error('Error al cargar configuraciÃ³n:', error);
                        showSettingsMessage('Error al cargar configuraciÃ³n.');
                    });
            }

            function handleSettingsSave() {
                const settings = {
                    displayName: settingsDisplayName.value.trim(),
                    cvu: settingsCvu.value.trim(),
                    metamask: settingsMetamask.value.trim()
                };
                fetch('/update-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, settings })
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            showSettingsMessage('ConfiguraciÃ³n guardada exitosamente.');
                            setTimeout(() => {
                                settingsContainer.classList.remove('active');
                                gameContainer.classList.add('active');
                                showSettingsMessage('');
                            }, 1000);
                        } else {
                            showSettingsMessage('Error al guardar configuraciÃ³n.');
                        }
                    })
                    .catch(error => {
                        console.error('Error al guardar configuraciÃ³n:', error);
                        showSettingsMessage('Error al guardar configuraciÃ³n.');
                    });
            }

            function handleSettingsBack() {
                settingsContainer.classList.remove('active');
                gameContainer.classList.add('active');
                showSettingsMessage('');
            }

            // Funciones de retiro
            async function sendWithdrawalNotification(amount, currency, realName, displayName, cvu) {
                try {
                    if (typeof emailjs === 'undefined') {
                        throw new Error('EmailJS no estÃ¡ disponible');
                    }
                    const templateParams = {
                        amount: amount,
                        currency: currency,
                        real_name: realName,
                        display_name: displayName || realName,
                        cvu: cvu || 'No proporcionado',
                        to_email: 'rod.arena7@gmail.com'
                    };
                    await emailjs.send('service_7du0586', '__ejs-test-mail-service__', templateParams);
                    showWithdrawMessage('Solicitud de retiro enviada.');
                } catch (error) {
                    console.error('Error al enviar notificaciÃ³n:', error);
                    showWithdrawMessage('Error al enviar solicitud de retiro. Verifica la configuraciÃ³n de EmailJS.');
                }
            }

            function handleWithdraw() {
                fetch(`/user/${username}`)
                    .then(response => response.json())
                    .then(user => {
                        if (!user.policiesAccepted || user.policiesVersion !== POLICIES_VERSION) {
                            showMessage('Debes aceptar las PolÃ­ticas y Condiciones para retirar Neig.');
                            return;
                        }
                        withdrawForm.classList.add('active');
                        gameContainer.classList.remove('active');
                        withdrawAmount.value = '';
                        withdrawCurrency.value = 'Neig';
                        showWithdrawMessage('');
                    })
                    .catch(error => {
                        console.error('Error al verificar usuario:', error);
                        showMessage('Error al conectar con el servidor.');
                    });
            }

            function handleWithdrawSubmit() {
                const amount = parseInt(withdrawAmount.value);
                const currency = withdrawCurrency.value;
                fetch(`/user/${username}`)
                    .then(response => response.json())
                    .then(user => {
                        const settings = user.settings || {};
                        if (!amount || amount <= 0) {
                            showWithdrawMessage('Por favor, ingresa una cantidad vÃ¡lida.');
                            return;
                        }
                        if (amount > playerCoins) {
                            showWithdrawMessage('No tienes suficientes Neig para retirar.');
                            return;
                        }
                        if (!settings.cvu && currency === 'Pesos') {
                            showWithdrawMessage('Por favor, ingresa un CVU/CBU o Alias en ConfiguraciÃ³n.');
                            return;
                        }
                        if (!settings.metamask && currency === 'Neig') {
                            showWithdrawMessage('Por favor, ingresa una direcciÃ³n MetaMask en ConfiguraciÃ³n.');
                            return;
                        }
                        fetch('/withdraw', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username, amount, currency })
                        })
                            .then(response => response.json())
                            .then(result => {
                                if (result.success) {
                                    playerCoins -= amount;
                                    updateUserCoins(username, playerCoins);
                                    updatePlayerInfo();
                                    sendWithdrawalNotification(amount, currency, username, settings.displayName, settings.cvu);
                                    withdrawForm.classList.remove('active');
                                    gameContainer.classList.add('active');
                                    showMessage(`Solicitud de retiro de ${amount} ${currency} enviada.`);
                                } else {
                                    showWithdrawMessage(result.detail || 'Error al procesar retiro.');
                                }
                            })
                            .catch(error => {
                                console.error('Error al procesar retiro:', error);
                                showWithdrawMessage('Error al conectar con el servidor.');
                            });
                    })
                    .catch(error => {
                        console.error('Error al verificar usuario:', error);
                        showWithdrawMessage('Error al conectar con el servidor.');
                    });
            }

            function handleWithdrawCancel() {
                withdrawForm.classList.remove('active');
                gameContainer.classList.add('active');
                showWithdrawMessage('');
            }

            // Funciones de recarga
function handleReload() {
    fetch(`/user/${username}`)
        .then(response => response.json())
        .then(user => {
            if (!user.policiesAccepted || user.policiesVersion !== POLICIES_VERSION) {
                showMessage('Debes aceptar las PolÃ­ticas y Condiciones para recargar Neig.');
                return;
            }
            reloadForm.classList.add('active');
            gameContainer.classList.remove('active');
            reloadAmount.value = '';
            showReloadMessage('');
        })
        .catch(error => {
            console.error('Error al verificar usuario:', error);
            showMessage('Error al conectar con el servidor.');
        });
}

async function handleReloadSubmit() {
    const amount = parseInt(reloadAmount.value);
    if (!amount || amount <= 0) {
        showReloadMessage('Por favor, ingresa una cantidad vÃ¡lida.');
        return;
    }
    confirmAmount.textContent = amount;
    reloadForm.classList.remove('active');
    confirmReloadModal.classList.add('active');
    showConfirmReloadMessage('');
}

async function handleConfirmReloadSubmit() {
    const amount = parseInt(confirmAmount.textContent);
    try {
        const response = await fetch('/create-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, amount })
        });
        const result = await response.json();
        if (result.success && result.paymentUrl) {
            // Redirigir al enlace de pago de Mercado Pago
            window.location.href = result.paymentUrl;
        } else {
            showConfirmReloadMessage(result.detail || 'Error al crear el enlace de pago.');
            confirmReloadModal.classList.remove('active');
            gameContainer.classList.add('active');
        }
    } catch (error) {
        console.error('Error al crear pago:', error);
        showConfirmReloadMessage('Error al conectar con el servidor.');
        confirmReloadModal.classList.remove('active');
        gameContainer.classList.add('active');
    }
}

function handleConfirmReloadCancel() {
    confirmReloadModal.classList.remove('active');
    gameContainer.classList.add('active');
    showConfirmReloadMessage('');
}

function handleReloadCancel() {
    reloadForm.classList.remove('active');
    gameContainer.classList.add('active');
    showReloadMessage('');
}

// Actualizar informaciÃ³n del jugador
function updatePlayerInfo() {
    usernameDisplay.textContent = `Usuario: ${username}`;
    coinsDisplay.textContent = `Saldo: ${playerCoins} Neig`;
}

// Actualizar monedas del usuario
function updateUserCoins(username, coins) {
    socket.emit('update coins', { username, coins });
}

// Manejar mensaje de recarga exitosa desde URL
function handlePaymentSuccess() {
    const urlParams = new URLSearchParams(window.location.search);
    const amount = urlParams.get('amount');
    if (amount) {
        const parsedAmount = parseInt(amount);
        if (!isNaN(parsedAmount)) {
            playerCoins += parsedAmount;
            updateUserCoins(username, playerCoins);
            updatePlayerInfo();
            showMessage(`Usted comprÃ³ ${parsedAmount} Neig`);
            // Limpiar parÃ¡metros de la URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    }
}

// Inicializar juego
function initializeGame() {
    socket.emit('join', username);
    initializeChat();
    updatePoliciesStatus();
    fetch(`/user/${username}`)
        .then(response => response.json())
        .then(user => {
            playerCoins = user.coins || 1000;
            updatePlayerInfo();
            // Verificar si hay un pago exitoso
            handlePaymentSuccess();
        })
        .catch(error => {
            console.error('Error al cargar datos del usuario:', error);
            showMessage('Error al cargar datos del usuario.');
        });
}

// Event Listeners
authSubmit.addEventListener('click', handleAuthSubmit);
authToggle.addEventListener('click', toggleAuthMode);
policiesAccept.addEventListener('click', handlePoliciesAccept);
policiesReject.addEventListener('click', handlePoliciesReject);
policiesLink.addEventListener('click', showPoliciesWindow);
statsButton.addEventListener('click', showStatsWindow);
settingsButton.addEventListener('click', () => {
    settingsContainer.classList.add('active');
    gameContainer.classList.remove('active');
    loadUserSettings();
});
settingsSave.addEventListener('click', handleSettingsSave);
settingsBack.addEventListener('click', handleSettingsBack);
withdrawButton.addEventListener('click', handleWithdraw);
withdrawSubmit.addEventListener('click', handleWithdrawSubmit);
withdrawCancel.addEventListener('click', handleWithdrawCancel);
reloadButton.addEventListener('click', handleReload);
reloadSubmit.addEventListener('click', handleReloadSubmit);
reloadCancel.addEventListener('click', handleReloadCancel);
confirmReloadSubmit.addEventListener('click', handleConfirmReloadSubmit);
confirmReloadCancel.addEventListener('click', handleConfirmReloadCancel);
competeButton.addEventListener('click', () => {
    fetch(`/user/${username}`)
        .then(response => response.json())
        .then(user => {
            if (!user.policiesAccepted || user.policiesVersion !== POLICIES_VERSION) {
                showMessage('Debes aceptar las PolÃ­ticas y Condiciones para jugar.');
                return;
            }
            if (playerCoins < 100) {
                showMessage('No tienes suficientes Neig. Recarga para continuar.');
                return;
            }
            if (!hasParticipated) {
                fetch('/compete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, sessionId })
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            playerCoins -= 100;
                            updateUserCoins(username, playerCoins);
                            updatePlayerInfo();
                            hasParticipated = true;
                            lastPlayer = username;
                            competeButton.disabled = true;
                            competeButton.textContent = 'Esperando Resultado...';
                            socket.emit('compete', { username });
                            showMessage('Â¡Has apostado 100 Neig! Espera el resultado.');
                        } else {
                            showMessage(result.detail || 'Error al competir.');
                        }
                    })
                    .catch(error => {
                        console.error('Error al competir:', error);
                        showMessage('Error al conectar con el servidor.');
                    });
            } else {
                showMessage('Ya has participado en esta ronda. Espera a que termine.');
            }
        })
        .catch(error => {
            console.error('Error al verificar usuario:', error);
            showMessage('Error al conectar con el servidor.');
        });
});

logoutButton.addEventListener('click', () => {
    fetch('/logout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, sessionId })
    })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                username = null;
                sessionId = null;
                playerCoins = 1000;
                hasParticipated = false;
                lastPlayer = null;
                gameContainer.classList.remove('active');
                authContainer.classList.add('active');
                showAuthMessage('SesiÃ³n cerrada exitosamente.', true);
                socket.emit('leave', username);
            } else {
                showMessage('Error al cerrar sesiÃ³n.');
            }
        })
        .catch(error => {
            console.error('Error al cerrar sesiÃ³n:', error);
            showMessage('Error al conectar con el servidor.');
        });
});

// Inicializar al cargar
fetch('/check-session', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ sessionId: localStorage.getItem('sessionId') })
})
    .then(response => response.json())
    .then(result => {
        if (result.success && result.username) {
            username = result.username;
            sessionId = result.sessionId;
            authContainer.classList.remove('active');
            fetch(`/user/${username}`)
                .then(response => response.json())
                .then(user => {
                    if (user.policiesAccepted && user.policiesVersion === POLICIES_VERSION && user.telegramVerified) {
                        gameContainer.classList.add('active');
                        initializeGame();
                    } else if (!user.telegramVerified) {
                        showVerificationInstructions(username);
                        showAuthMessage(`Debes verificar tu cuenta enviando /start ${username} a @NeigBot en Telegram.`);
                    } else {
                        policiesContainer.classList.add('active');
                    }
                })
                .catch(error => {
                    console.error('Error al verificar usuario:', error);
                    authContainer.classList.add('active');
                });
        }
    })
    .catch(error => {
        console.error('Error al verificar sesiÃ³n:', error);
        authContainer.classList.add('active');
    });
});
</script>
</body>
</html>
