<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neigame - Competencia Neighborcoin</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="/output.css" rel="stylesheet">
    <link rel="icon" href="/favicon.ico">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background: url('/images/background.jpg') no-repeat center center fixed;
            background-size: cover;
            background-color: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            image-rendering: pixelated;
        }
        #auth-container, #game-container, #chat-container {
            display: none;
            flex-direction: column;
            align-items: center;
            margin-top: 1rem;
            width: 100%;
            max-width: 500px;
        }
        #auth-container.active, #game-container.active {
            display: flex;
        }
        #auth-form, #chat-container {
            background-color: rgba(0, 0, 0, 0.9);
            padding: 1rem;
            border: 4px solid #ffeb3b;
            border-radius: 8px;
            box-shadow: 0 0 10px #ffeb3b, 0 0 20px #e91e63;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        #auth-form input, #message-input {
            width: 100%;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border: 2px solid #03a9f4;
            border-radius: 4px;
            background-color: #1a237e;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem;
        }
        #auth-form button, #compete-button, #send-button, #record-button, #logout-button {
            padding: 0.5rem 1rem;
            margin: 0.5rem;
            font-size: 0.8rem;
            background-color: #e91e63;
            color: #fff;
            border: 2px solid #ffeb3b;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-family: 'Press Start 2P', cursive;
        }
        #auth-form button:hover, #compete-button:hover, #send-button:hover, #record-button:hover, #logout-button:hover {
            background-color: #c2185b;
        }
        #record-button.recording {
            background-color: #4caf50;
            border-color: #4caf50;
        }
        #auth-toggle {
            color: #03a9f4;
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.7rem;
        }
        #auth-message, #chat-message, #message-box {
            color: #ffeb3b;
            font-size: 0.7rem;
            margin-top: 0.5rem;
        }
        #user-info, #pot-display, #timer-display {
            width: 100%;
            margin-bottom: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.5rem;
            border: 2px solid #ffeb3b;
            border-radius: 4px;
            text-align: center;
        }
        #user-info p, #pot-display, #timer-display p {
            font-size: 0.7rem;
            color: #ffeb3b;
            text-shadow: 0 0 5px #e91e63;
            margin: 0;
        }
        #pot-display {
            font-size: 1.2rem;
            border: 4px solid #03a9f4;
            width: 150px;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 0 8px #e91e63;
            box-shadow: 0 0 10px #03a9f4;
        }
        #timer-display {
            border: 2px solid #4caf50;
        }
        #compete-button:disabled {
            background-color: #616161;
            cursor: not-allowed;
            opacity: 0.6;
        }
        #messages {
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.9);
            border: 4px solid #ffeb3b;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .message {
            margin: 0.5rem 0;
            font-size: 0.7rem;
            color: #ffeb3b;
            text-shadow: 0 0 5px #e91e63;
        }
        .message.audio {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #users-list {
            width: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            border: 4px solid #03a9f4;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.7rem;
            color: #4caf50;
            text-shadow: 0 0 5px #4caf50;
        }
        #users-list ul {
            list-style: none;
            padding: 0.5rem 0;
        }
        #users-list li {
            color: #ffeb3b;
            margin: 0.2rem 0;
        }
        #message-form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        #message-input {
            height: 60px;
            resize: none;
        }
        #message-buttons {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }
        @media (max-width: 640px) {
            body { padding: 5px; }
            #auth-container, #game-container, #chat-container { max-width: 90%; }
            #auth-form, #chat-container { padding: 0.5rem; }
            #pot-display { width: 120px; height: 120px; font-size: 1rem; }
            .button, #compete-button, #send-button, #record-button { padding: 0.5rem; font-size: 0.7rem; }
            #messages, #users-list { padding: 0.5rem; }
            #message-input { height: 50px; font-size: 0.7rem; }
        }
    </style>
</head>
<body>
    <!-- Autenticación -->
    <div id="auth-container" class="active">
        <div id="auth-form">
            <h2 id="auth-title">Iniciar Sesión</h2>
            <input type="text" id="auth-username" placeholder="Usuario" required>
            <input type="password" id="auth-password" placeholder="Contraseña" required>
            <input type="password" id="auth-confirm-password" placeholder="Confirmar Contraseña" style="display: none;" required>
            <button id="auth-submit">Iniciar Sesión</button>
            <p id="auth-toggle">¿No tienes cuenta? Regístrate</p>
            <p id="auth-message"></p>
        </div>
    </div>

    <!-- Juego -->
    <div id="game-container">
        <div id="user-info">
            <p id="username-display">Usuario: </p>
        </div>
        <div id="pot-display">Pozo: 0 Neig</div>
        <div id="timer-display">
            <p>Tiempo Restante: 240 segundos</p>
        </div>
        <button id="compete-button">Jugar</button>
        <div id="message-box">Bienvenido al juego.</div>
        <button id="logout-button">Cerrar Sesión</button>
        <div id="chat-container">
            <div id="users-list">Usuarios conectados: 0</div>
            <div id="messages"></div>
            <form id="message-form">
                <textarea id="message-input" placeholder="Escribe un mensaje"></textarea>
                <div id="message-buttons">
                    <button type="button" id="record-button">Grabar Audio</button>
                    <button type="submit" id="send-button">Enviar</button>
                </div>
                <p id="chat-message"></p>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Elementos del DOM
            const authContainer = document.getElementById('auth-container');
            const gameContainer = document.getElementById('game-container');
            const authTitle = document.getElementById('auth-title');
            const authUsername = document.getElementById('auth-username');
            const authPassword = document.getElementById('auth-password');
            const authConfirmPassword = document.getElementById('auth-confirm-password');
            const authSubmit = document.getElementById('auth-submit');
            const authToggle = document.getElementById('auth-toggle');
            const authMessage = document.getElementById('auth-message');
            const usernameDisplay = document.getElementById('username-display');
            const potDisplay = document.getElementById('pot-display');
            const timerDisplay = document.getElementById('timer-display');
            const competeButton = document.getElementById('compete-button');
            const messageBox = document.getElementById('message-box');
            const logoutButton = document.getElementById('logout-button');
            const messages = document.getElementById('messages');
            const messageInput = document.getElementById('message-input');
            const recordButton = document.getElementById('record-button');
            const sendButton = document.getElementById('send-button');
            const messageForm = document.getElementById('message-form');
            const usersList = document.getElementById('users-list');
            const chatMessage = document.getElementById('chat-message');

            let username = null;
            let hasParticipated = false;
            let mediaRecorder = null;
            let isLoginMode = true;

            // Socket.IO
            const socket = io('https://neigame.onrender.com', {
                transports: ['websocket', 'polling'],
                reconnectionAttempts: 5,
                path: '/socket.io'
            });

            socket.on('connect', () => {
                console.log('Conectado al servidor');
                if (username) {
                    socket.emit('join', username);
                }
            });

            socket.on('connect_error', (error) => {
                console.error('Error de conexión:', error);
                showMessage('Error al conectar con el servidor.');
            });

            // Chat
            socket.on('chat message', ({ user, message, type }) => {
                addMessage({ user, content: message, type });
            });

            socket.on('users update', (users) => {
                updateUsersList(users);
            });

            socket.on('user joined', ({ user }) => {
                addMessage({ user: 'Sistema', content: `${user} se ha unido`, type: 'text' });
            });

            socket.on('user left', ({ user }) => {
                addMessage({ user: 'Sistema', content: `${user} ha abandonado`, type: 'text' });
            });

            // Temporizador
            socket.on('timer update', ({ seconds, pot, winner }) => {
                potDisplay.textContent = `Pozo: ${pot} Neig`;
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                timerDisplay.querySelector('p').textContent = `Tiempo Restante: ${minutes}:${secs < 10 ? '0' : ''}${secs}`;
                if (seconds <= 0 && winner) {
                    showMessage(`¡${winner} ganó ${Math.round(pot * 0.89)} Neig!`);
                    hasParticipated = false;
                    competeButton.disabled = false;
                }
            });

            // Funciones de Mensajes
            function showMessage(message) {
                messageBox.textContent = message;
            }

            function showAuthMessage(message) {
                authMessage.textContent = message;
            }

            function showChatMessage(message) {
                chatMessage.textContent = message;
                setTimeout(() => chatMessage.textContent = '', 3000);
            }

            // Funciones de Chat
            function addMessage({ user, content, type = 'text' }) {
                const div = document.createElement('div');
                div.className = `message ${type}`;
                if (type === 'text') {
                    div.textContent = `${user}: ${content}`;
                } else if (type === 'audio') {
                    const audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = content;
                    div.textContent = `${user}: `;
                    div.appendChild(audio);
                }
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
            }

            function updateUsersList(users) {
                usersList.innerHTML = `Usuarios conectados: ${users.length}`;
                const ul = document.createElement('ul');
                users.forEach(user => {
                    const li = document.createElement('li');
                    li.textContent = user;
                    ul.appendChild(li);
                });
                usersList.appendChild(ul);
            }

            messageForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const message = messageInput.value.trim();
                if (message && username) {
                    socket.emit('chat message', { user: username, message, type: 'text' });
                    messageInput.value = '';
                } else {
                    showChatMessage('Inicia sesión para enviar mensajes.');
                }
            });

            recordButton.addEventListener('click', async () => {
                if (!username) {
                    showChatMessage('Inicia sesión para grabar audio.');
                    return;
                }
                if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        const chunks = [];
                        mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
                        mediaRecorder.onstop = () => {
                            const blob = new Blob(chunks, { type: 'audio/webm' });
                            const reader = new FileReader();
                            reader.onload = () => {
                                socket.emit('chat message', {
                                    user: username,
                                    message: reader.result,
                                    type: 'audio'
                                });
                            };
                            reader.readAsDataURL(blob);
                        };
                        mediaRecorder.start();
                        recordButton.textContent = 'Detener Grabación';
                        recordButton.classList.add('recording');
                    } catch (error) {
                        showChatMessage('Error al acceder al micrófono.');
                        console.error(error);
                    }
                } else {
                    mediaRecorder.stop();
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    recordButton.textContent = 'Grabar Audio';
                    recordButton.classList.remove('recording');
                }
            });

            // Gestión de Usuarios
            function saveUser(username, password) {
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                users[username] = { password };
                localStorage.setItem('users', JSON.stringify(users));
            }

            function getUser(username, callback) {
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                callback(users[username] || {});
            }

            function loginUser(username, password, callback) {
                getUser(username, user => {
                    if (user && user.password === password) {
                        localStorage.setItem('currentUser', username);
                        callback(true);
                    } else {
                        callback(false);
                    }
                });
            }

            function registerUser(username, password, callback) {
                getUser(username, user => {
                    if (user && user.password) {
                        callback(false);
                    } else {
                        saveUser(username, password);
                        localStorage.setItem('currentUser', username);
                        callback(true);
                    }
                });
            }

            // Autenticación
            function handleAuthSubmit() {
                const usernameInput = authUsername.value.trim();
                const passwordInput = authPassword.value.trim();
                const confirmPasswordInput = authConfirmPassword.value.trim();

                if (!usernameInput || !passwordInput) {
                    showAuthMessage('Completa todos los campos.');
                    return;
                }

                if (!isLoginMode && passwordInput !== confirmPasswordInput) {
                    showAuthMessage('Las contraseñas no coinciden.');
                    return;
                }

                if (isLoginMode) {
                    loginUser(usernameInput, passwordInput, success => {
                        if (success) {
                            username = usernameInput;
                            authContainer.classList.remove('active');
                            gameContainer.classList.add('active');
                            initializeGame();
                        } else {
                            showAuthMessage('Usuario o contraseña incorrectos.');
                        }
                    });
                } else {
                    registerUser(usernameInput, passwordInput, success => {
                        if (success) {
                            username = usernameInput;
                            authContainer.classList.remove('active');
                            gameContainer.classList.add('active');
                            initializeGame();
                        } else {
                            showAuthMessage('El usuario ya existe.');
                        }
                    });
                }
            }

            function toggleAuthMode() {
                isLoginMode = !isLoginMode;
                authTitle.textContent = isLoginMode ? 'Iniciar Sesión' : 'Registrarse';
                authSubmit.textContent = isLoginMode ? 'Iniciar Sesión' : 'Registrarse';
                authToggle.textContent = isLoginMode ? '¿No tienes cuenta? Regístrate' : '¿Ya tienes cuenta? Inicia sesión';
                authConfirmPassword.style.display = isLoginMode ? 'none' : 'block';
                showAuthMessage('');
                authUsername.value = '';
                authPassword.value = '';
                authConfirmPassword.value = '';
            }

            // Juego
            function handleCompete() {
                if (!hasParticipated) {
                    socket.emit('compete', { username });
                    hasParticipated = true;
                    competeButton.disabled = true;
                    showMessage('Has participado en la ronda.');
                } else {
                    showMessage('Ya participaste en esta ronda.');
                }
            }

            function handleLogout() {
                socket.emit('leave', username);
                localStorage.removeItem('currentUser');
                authContainer.classList.add('active');
                gameContainer.classList.remove('active');
                username = null;
                hasParticipated = false;
                showAuthMessage('Sesión cerrada.');
            }

            function initializeGame() {
                usernameDisplay.textContent = `Usuario: ${username}`;
                socket.emit('join', username);
                showMessage(`¡Bienvenido, ${username}!`);
            }

            // Verificar usuario existente
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                getUser(currentUser, user => {
                    if (user && user.password) {
                        username = currentUser;
                        authContainer.classList.remove('active');
                        gameContainer.classList.add('active');
                        initializeGame();
                    } else {
                        localStorage.removeItem('currentUser');
                        showAuthMessage('Inicia sesión nuevamente.');
                    }
                });
            }

            // Event Listeners
            authSubmit.addEventListener('click', handleAuthSubmit);
            authToggle.addEventListener('click', toggleAuthMode);
            competeButton.addEventListener('click', handleCompete);
            logoutButton.addEventListener('click', handleLogout);
        });
    </script>
</body>
</html>
