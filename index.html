<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Competencia por Neig con Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // Definir showErrorMessage en el Ã¡mbito global
        function showErrorMessage(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
            } else {
                console.warn(`Elemento con ID ${elementId} no encontrado: ${message}`);
                const fallbackElement = document.getElementById('message-box');
                if (fallbackElement) {
                    fallbackElement.textContent = message;
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background: url('https://images.unsplash.com/photo-1611345613376-12b6f4a7e6cb?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80') no-repeat center center fixed;
            background-size: cover;
            background-color: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            image-rendering: pixelated;
        }
        #game-container, #auth-container, #settings-container, #policies-container, #chat-container {
            display: none;
            flex-direction: column;
            align-items: center;
            margin-top: 1rem;
            width: 100%;
            max-width: 500px;
        }
        #auth-container.active, #game-container.active, #settings-container.active, #policies-container.active {
            display: flex;
        }
        #auth-form, #settings-form, #policies-form, #withdraw-form, #chat-container {
            background-color: rgba(0, 0, 0, 0.9);
            padding: 1rem;
            border: 4px solid #ffeb3b;
            border-radius: 8px;
            box-shadow: 0 0 10px #ffeb3b, 0 0 20px #e91e63;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        #auth-form input, #settings-form input, #withdraw-form input, #withdraw-form select, #message-input {
            width: 100%;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border: 2px solid #03a9f4;
            border-radius: 4px;
            background-color: #1a237e;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem;
        }
        #auth-form button, #settings-form button, #policies-form button, #withdraw-form button, #stats-button, #record-button, #send-button {
            padding: 0.5rem 1rem;
            margin: 0.5rem;
            font-size: 0.8rem;
            background-color: #e91e63;
            color: #fff;
            border: 2px solid #ffeb3b;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-family: 'Press Start 2P', cursive;
        }
        #auth-form button:hover, #settings-form button:hover, #policies-form button:hover, #withdraw-form button:hover, #stats-button:hover, #record-button:hover, #send-button:hover {
            background-color: #c2185b;
        }
        #record-button.recording {
            background-color: #4caf50;
            border-color: #4caf50;
        }
        #auth-toggle, #forgot-password {
            color: #03a9f4;
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.7rem;
        }
        #forgot-password {
            margin-top: 0.5rem;
        }
        #forgot-password a {
            color: #03a9f4;
        }
        #forgot-password a:hover {
            color: #0288d1;
        }
        #auth-message, #settings-message, #policies-message, #withdraw-message, #chat-message {
            color: #ffeb3b;
            font-size: 0.7rem;
            margin-top: 0.5rem;
        }
        #policies-content {
            max-height: 250px;
            overflow-y: auto;
            text-align: left;
            font-size: 0.6rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border: 2px solid #03a9f4;
            background-color: #1a237e;
        }
        #user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.5rem;
            border: 2px solid #ffeb3b;
            border-radius: 4px;
        }
        #user-info p {
            font-size: 0.7rem;
            color: #ffeb3b;
            text-shadow: 0 0 5px #e91e63;
        }
        #pot-display {
            font-size: 1.2rem;
            color: #ffeb3b;
            background: rgba(0, 0, 0, 0.8);
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border: 4px solid #03a9f4;
            border-radius: 8px;
            width: 150px;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            text-shadow: 0 0 8px #e91e63;
            box-shadow: 0 0 10px #03a9f4;
        }
        #timer-display {
            font-size: 0.8rem;
            color: #4caf50;
            margin-bottom: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.5rem;
            border: 2px solid #4caf50;
            border-radius: 4px;
        }
        #timer-display p {
            margin-bottom: 0.5rem;
            text-shadow: 0 0 5px #4caf50;
        }
        #compete-button {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            background-color: #e91e63;
            color: #fff;
            border: 2px solid #ffeb3b;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            margin-bottom: 0.5rem;
            font-family: 'Press Start 2P', cursive;
        }
        #compete-button:hover {
            background-color: #c2185b;
        }
        #compete-button:disabled {
            background-color: #616161;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
        }
        #message-box {
            background-color: rgba(0, 0, 0, 0.8);
            color: #ffeb3b;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border: 2px solid #03a9f4;
            border-radius: 4px;
            text-align: center;
            width: 100%;
            max-width: 400px;
            font-size: 0.7rem;
            text-shadow: 0 0 5px #03a9f4;
        }
        .button {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            background-color: #03a9f4;
            color: #fff;
            border: 2px solid #ffeb3b;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            margin: 0.25rem;
            font-family: 'Press Start 2P', cursive;
        }
        .button:hover {
            background-color: #0288d1;
        }
        .button:disabled {
            background-color: #616161;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
        }
        #withdraw-form {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: none;
        }
        #withdraw-form.active {
            display: block;
        }
        #policies-status {
            display: flex;
            align-items: center;
            font-size: 0.7rem;
            margin-top: 0.5rem;
        }
        #policies-status input[type="checkbox"] {
            margin-right: 0.5rem;
        }
        #policies-status a {
            color: #03a9f4;
            text-decoration: underline;
            cursor: pointer;
        }
        #policies-status.accepted {
            color: #4caf50;
        }
        #policies-status.rejected {
            color: #e91e63;
        }
        #messages {
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.9);
            border: 4px solid #ffeb3b;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .message {
            margin: 0.5rem 0;
            font-size: 0.7rem;
            color: #ffeb3b;
            text-shadow: 0 0 5px #e91e63;
        }
        .message.audio {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #users-list {
            width: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            border: 4px solid #03a9f4;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.7rem;
            color: #4caf50;
            text-shadow: 0 0 5px #4caf50;
        }
        #users-list ul {
            list-style: none;
            padding: 0.5rem 0;
        }
        #users-list li {
            color: #ffeb3b;
            margin: 0.2rem 0;
            font-size: 0.7rem;
            text-shadow: 0 0 5px #03a9f4;
        }
        #message-form {
            width: 100%;
        }
        @media (max-width: 640px) {
            body {
                padding: 5px;
            }
            #game-container, #auth-container, #settings-container, #policies-container, #chat-container {
                margin-top: 0.5rem;
                max-width: 90%;
            }
            #auth-form, #settings-form, #policies-form, #withdraw-form, #chat-container {
                padding: 0.5rem;
            }
            #pot-display {
                width: 120px;
                height: 120px;
                font-size: 1rem;
            }
            .button, #compete-button, #stats-button, #record-button, #send-button {
                padding: 0.5rem;
                font-size: 0.7rem;
            }
            #messages, #users-list {
                padding: 0.5rem;
            }
            #message-input {
                font-size: 0.6rem;
            }
            .message {
                font-size: 0.6rem;
            }
        }
    </style>
</head>
<body>
    <div id="auth-container" class="active">
        <div id="auth-form">
            <h2 id="auth-title">Iniciar SesiÃ³n</h2>
            <input type="text" id="auth-username" placeholder="Usuario" required>
            <input type="password" id="auth-password" placeholder="ContraseÃ±a" required>
            <input type="password" id="auth-confirm-password" placeholder="Confirmar ContraseÃ±a" style="display: none;" required>
            <button id="auth-submit">Iniciar SesiÃ³n</button>
            <p id="auth-toggle">Â¿No tienes cuenta? RegÃ­strate</p>
            <p id="forgot-password" style="display: block;"><a href="javascript:void(0)">Â¿Olvidaste tu contraseÃ±a? Click aquÃ­</a></p>
            <p id="auth-message"></p>
        </div>
    </div>
    <div id="policies-container">
        <div id="policies-form">
            <h2>PolÃ­ticas y Condiciones</h2>
            <div id="policies-content">
                <p><strong>Ãltima actualizaciÃ³n: 2 de mayo de 2025</strong></p>
                <p>Bienvenido a "La Moneda del Vecindario", una comunidad que utiliza Neighborcoin (Neig) como token para participar en nuestro juego competitivo...</p>
            </div>
            <button id="policies-accept">Aceptar</button>
            <button id="policies-reject">Rechazar</button>
            <p id="policies-message"></p>
        </div>
    </div>
    <div id="game-container">
        <div id="user-info">
            <p id="username-display">Usuario: </p>
            <p id="coins-display">Saldo: 1000 Neig</p>
        </div>
        <button id="stats-button">EstadÃ­sticas</button>
        <div id="pot-display">Pozo: 0 Neig</div>
        <div id="timer-display">
            <p>Tiempo Restante: 240 segundos</p>
            <div id="progress-bar" style="width: 100%; height: 10px; background-color: #1a237e; border-radius: 5px; margin-top: 0.5rem; position: relative;">
                <div id="progress-bar-fill" style="height: 10px; background-color: #4caf50; border-radius: 5px; width: 100%;"></div>
            </div>
            <p id="timer-percentage">100%</p>
        </div>
        <button id="compete-button">Jugar</button>
        <div id="message-box">Bienvenido al juego. Â¡Presiona el botÃ³n para competir!</div>
        <div class="flex flex-wrap justify-center gap-2">
            <button id="reload-button" class="button">Recargar Neig</button>
            <button id="withdraw-button" class="button">Retirar Neig</button>
            <button id="settings-button" class="button">ConfiguraciÃ³n</button>
            <button id="logout-button" class="button">Cerrar SesiÃ³n</button>
        </div>
        <div id="chat-container">
            <div id="users-list">Usuarios conectados: 0</div>
            <div id="messages"></div>
            <form id="message-form">
                <input type="text" id="message-input" placeholder="Escribe un mensaje">
                <button type="button" id="record-button">Grabar Audio</button>
                <button type="submit" id="send-button">Enviar</button>
                <p id="chat-message"></p>
            </form>
        </div>
        <div id="policies-status">
            <input type="checkbox" id="policies-checkbox" disabled>
            <span id="policies-text"></span>
            <a id="policies-link" href="javascript:void(0)">PolÃ­ticas y Condiciones</a>
        </div>
    </div>
    <div id="settings-container">
        <div id="settings-form">
            <h2>ConfiguraciÃ³n</h2>
            <input type="text" id="settings-display-name" placeholder="Nombre ficticio">
            <input type="email" id="settings-email" placeholder="Correo electrÃ³nico">
            <input type="text" id="settings-cvu" placeholder="CVU/CBU o Alias">
            <input type="text" id="settings-metamask" placeholder="DirecciÃ³n MetaMask">
            <button id="settings-save">Guardar</button>
            <button id="settings-back">Volver</button>
            <p id="settings-message"></p>
        </div>
    </div>
    <div id="withdraw-form">
        <h2>Retirar Neig</h2>
        <input type="number" id="withdraw-amount" placeholder="Cantidad a retirar" min="1" required>
        <select id="withdraw-currency">
            <option value="Neig">Neig</option>
            <option value="Pesos">Pesos</option>
        </select>
        <button id="withdraw-submit">Confirmar Retiro</button>
        <button id="withdraw-cancel">Cancelar</button>
        <p id="withdraw-message"></p>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4.4.1/dist/email.min.js" onerror="showErrorMessage('auth-message', 'Error al cargar EmailJS. Verifica tu conexiÃ³n.')"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar EmailJS
            try {
                if (typeof emailjs !== 'undefined') {
                    emailjs.init("KWVSgPsdHmSAURvGd"); // Public Key
                } else {
                    showErrorMessage('auth-message', 'EmailJS no estÃ¡ disponible. Verifica tu conexiÃ³n.');
                }
            } catch (error) {
                console.error('Error al inicializar EmailJS:', error);
                showErrorMessage('auth-message', 'Error al cargar EmailJS. Verifica tu conexiÃ³n.');
            }

            // ConfiguraciÃ³n inicial
            const POLICIES_VERSION = "1.0.0";
            let playerCoins = 1000;
            let hasParticipated = false;
            let username = null;
            let sessionId = null;
            const developerPercentage = 0.05;
            const potPercentage = 0.06;
            let pot = 0;
            let timerInterval = null;

            // Elementos del DOM
            const authContainer = document.getElementById('auth-container');
            const gameContainer = document.getElementById('game-container');
            const settingsContainer = document.getElementById('settings-container');
            const policiesContainer = document.getElementById('policies-container');
            const withdrawForm = document.getElementById('withdraw-form');
            const authTitle = document.getElementById('auth-title');
            const authUsername = document.getElementById('auth-username');
            const authPassword = document.getElementById('auth-password');
            const authConfirmPassword = document.getElementById('auth-confirm-password');
            const authSubmit = document.getElementById('auth-submit');
            const authToggle = document.getElementById('auth-toggle');
            const forgotPassword = document.getElementById('forgot-password');
            const authMessage = document.getElementById('auth-message');
            const statsButton = document.getElementById('stats-button');
            const potDisplay = document.getElementById('pot-display');
            const timerDisplay = document.getElementById('timer-display');
            const competeButton = document.getElementById('compete-button');
            const messageBox = document.getElementById('message-box');
            const reloadButton = document.getElementById('reload-button');
            const withdrawButton = document.getElementById('withdraw-button');
            const settingsButton = document.getElementById('settings-button');
            const logoutButton = document.getElementById('logout-button');
            const usernameDisplay = document.getElementById('username-display');
            const coinsDisplay = document.getElementById('coins-display');
            const progressBarFill = document.getElementById('progress-bar-fill');
            const timerPercentageDisplay = document.getElementById('timer-percentage');
            const settingsDisplayName = document.getElementById('settings-display-name');
            const settingsEmail = document.getElementById('settings-email');
            const settingsCvu = document.getElementById('settings-cvu');
            const settingsMetamask = document.getElementById('settings-metamask');
            const settingsSave = document.getElementById('settings-save');
            const settingsBack = document.getElementById('settings-back');
            const settingsMessage = document.getElementById('settings-message');
            const withdrawAmount = document.getElementById('withdraw-amount');
            const withdrawCurrency = document.getElementById('withdraw-currency');
            const withdrawSubmit = document.getElementById('withdraw-submit');
            const withdrawCancel = document.getElementById('withdraw-cancel');
            const withdrawMessage = document.getElementById('withdraw-message');
            const policiesAccept = document.getElementById('policies-accept');
            const policiesReject = document.getElementById('policies-reject');
            const policiesMessage = document.getElementById('policies-message');
            const policiesStatus = document.getElementById('policies-status');
            const policiesCheckbox = document.getElementById('policies-checkbox');
            const policiesText = document.getElementById('policies-text');
            const policiesLink = document.getElementById('policies-link');
            const messages = document.getElementById('messages');
            const messageInput = document.getElementById('message-input');
            const recordButton = document.getElementById('record-button');
            const sendButton = document.getElementById('send-button');
            const messageForm = document.getElementById('message-form');
            const usersList = document.getElementById('users-list');
            const chatMessage = document.getElementById('chat-message');

            // Estado de autenticaciÃ³n
            let isLoginMode = true;

            // PolÃ­ticas en HTML (abreviado)
            const policiesHtml = `<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><title>PolÃ­ticas</title></head><body><h1>PolÃ­ticas y Condiciones</h1><p>Ãltima actualizaciÃ³n: 2 de mayo de 2025</p>...</body></html>`;
            const statsHtml = `<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><title>EstadÃ­sticas</title></head><body><h1>EstadÃ­sticas del Juego</h1><p>No hay estadÃ­sticas disponibles en modo local.</p></body></html>`;

            // ConfiguraciÃ³n del chat
            const socket = io('http://localhost:3000'); // Reemplaza con la URL de tu servidor
            let mediaRecorder = null;

            function showChatMessage(message) {
                chatMessage.textContent = message;
                setTimeout(() => chatMessage.textContent = '', 3000);
            }

            function addMessage({ user, content, type = 'text' }) {
                const div = document.createElement('div');
                div.className = `message ${type}`;
                if (type === 'text') {
                    div.textContent = `${user}: ${content}`;
                } else if (type === 'audio') {
                    const audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = content;
                    div.textContent = `${user}: `;
                    div.appendChild(audio);
                }
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
            }

            function updateUsersList(users) {
                usersList.innerHTML = `Usuarios conectados: ${users.length}`;
                if (users.length > 0) {
                    const ul = document.createElement('ul');
                    ul.style.listStyle = 'none';
                    ul.style.padding = '0.5rem 0';
                    users.forEach(user => {
                        const li = document.createElement('li');
                        li.textContent = user;
                        li.style.color = '#ffeb3b';
                        li.style.margin = '0.2rem 0';
                        ul.appendChild(li);
                    });
                    usersList.appendChild(ul);
                }
            }

            socket.on('chat message', ({ user, message, type }) => {
                addMessage({ user, content: message, type });
            });

            socket.on('users update', (users) => {
                updateUsersList(users);
            });

            socket.on('user joined', ({ user }) => {
                addMessage({ user: 'Sistema', content: `${user} se ha unido al chat`, type: 'text' });
            });

            socket.on('user left', ({ user }) => {
                addMessage({ user: 'Sistema', content: `${user} ha abandonado el chat`, type: 'text' });
            });

            sendButton.addEventListener('click', (e) => {
                e.preventDefault();
                const message = messageInput.value.trim();
                if (message) {
                    getUser(username, user => {
                        const displayName = user.settings && user.settings.displayName ? user.settings.displayName : username;
                        socket.emit('chat message', { user: displayName, message, type: 'text' });
                        messageInput.value = '';
                    });
                }
            });

            recordButton.addEventListener('click', async () => {
                if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        const chunks = [];

                        mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
                        mediaRecorder.onstop = () => {
                            const blob = new Blob(chunks, { type: 'audio/webm' });
                            const reader = new FileReader();
                            reader.onload = () => {
                                getUser(username, user => {
                                    const displayName = user.settings && user.settings.displayName ? user.settings.displayName : username;
                                    socket.emit('chat message', {
                                        user: displayName,
                                        message: reader.result,
                                        type: 'audio'
                                    });
                                });
                            };
                            reader.readAsDataURL(blob);
                        };

                        mediaRecorder.start();
                        recordButton.textContent = 'Detener GrabaciÃ³n';
                        recordButton.classList.add('recording');
                    } catch (error) {
                        showChatMessage('Error al acceder al micrÃ³fono.');
                        console.error(error);
                    }
                } else {
                    mediaRecorder.stop();
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    recordButton.textContent = 'Grabar Audio';
                    recordButton.classList.remove('recording');
                }
            });

            // Funciones de mensajes
            function showAuthMessage(message) {
                if (authMessage) {
                    authMessage.textContent = message;
                } else {
                    console.warn('Elemento auth-message no encontrado');
                }
            }

            function showMessage(message) {
                if (messageBox) {
                    messageBox.textContent = message;
                    while (messageBox.childNodes.length > 1) {
                        messageBox.removeChild(messageBox.lastChild);
                    }
                } else {
                    console.warn('Elemento message-box no encontrado');
                }
            }

            function showPoliciesMessage(message) {
                if (policiesMessage) {
                    policiesMessage.textContent = message;
                } else {
                    console.warn('Elemento policies-message no encontrado');
                }
            }

            function showSettingsMessage(message) {
                if (settingsMessage) {
                    settingsMessage.textContent = message;
                } else {
                    console.warn('Elemento settings-message no encontrado');
                }
            }

            function showWithdrawMessage(message) {
                if (withdrawMessage) {
                    withdrawMessage.textContent = message;
                } else {
                    console.warn('Elemento withdraw-message no encontrado');
                }
            }

            // Funciones de autenticaciÃ³n
            function saveUser(username, password, coins = 1000, settings = {}, policiesAccepted = false, policiesVersion = '') {
                try {
                    const users = JSON.parse(localStorage.getItem('users') || '{}');
                    users[username] = { password, coins, settings, policiesAccepted, policiesVersion };
                    localStorage.setItem('users', JSON.stringify(users));
                } catch (error) {
                    console.error('Error al guardar usuario:', error);
                    showAuthMessage('Error al guardar datos del usuario.');
                }
            }

            function getUser(username, callback) {
                try {
                    const users = JSON.parse(localStorage.getItem('users') || '{}');
                    callback(users[username] || {});
                } catch (error) {
                    console.error('Error en getUser:', error);
                    callback({});
                }
            }

            function loginUser(username, password, callback) {
                getUser(username, user => {
                    try {
                        if (user && user.password === password) {
                            const sessionId = Date.now().toString() + Math.random().toString(36).substr(2);
                            localStorage.setItem('session_' + username, sessionId);
                            localStorage.setItem('currentUser', username);
                            callback({ success: true, sessionId, policiesAccepted: user.policiesAccepted, policiesVersion: user.policiesVersion });
                        } else {
                            callback({ success: false });
                        }
                    } catch (error) {
                        console.error('Error en loginUser:', error);
                        callback({ success: false });
                    }
                });
            }

            function registerUser(username, password, callback) {
                getUser(username, user => {
                    try {
                        if (user && user.password) {
                            callback(false);
                        } else {
                            saveUser(username, password);
                            const sessionId = Date.now().toString() + Math.random().toString(36).substr(2);
                            localStorage.setItem('session_' + username, sessionId);
                            localStorage.setItem('currentUser', username);
                            callback(true);
                        }
                    } catch (error) {
                        console.error('Error en registerUser:', error);
                        callback(false);
                    }
                });
            }

            function checkSession(username) {
                return localStorage.getItem('session_' + username);
            }

            function updateUserCoins(username, coins) {
                try {
                    const users = JSON.parse(localStorage.getItem('users') || '{}');
                    if (users[username]) {
                        users[username].coins = coins;
                        localStorage.setItem('users', JSON.stringify(users));
                    }
                } catch (error) {
                    console.error('Error al actualizar monedas:', error);
                    showMessage('Error al actualizar saldo.');
                }
            }

            function updateUserSettings(username, settings) {
                try {
                    const users = JSON.parse(localStorage.getItem('users') || '{}');
                    if (users[username]) {
                        users[username].settings = settings;
                        localStorage.setItem('users', JSON.stringify(users));
                    }
                } catch (error) {
                    console.error('Error al actualizar configuraciÃ³n:', error);
                    showSettingsMessage('Error al guardar configuraciÃ³n.');
                }
            }

            function updateUserPolicies(username, accepted, version) {
                try {
                    const users = JSON.parse(localStorage.getItem('users') || '{}');
                    if (users[username]) {
                        users[username].policiesAccepted = accepted;
                        users[username].policiesVersion = version;
                        localStorage.setItem('users', JSON.stringify(users));
                    }
                } catch (error) {
                    console.error('Error al actualizar polÃ­ticas:', error);
                    showPoliciesMessage('Error al actualizar polÃ­ticas.');
                }
            }

            function handleAuthSubmit() {
                const usernameInput = authUsername.value.trim();
                const passwordInput = authPassword.value.trim();
                const confirmPasswordInput = authConfirmPassword.value.trim();

                if (!usernameInput || !passwordInput) {
                    showAuthMessage('Por favor, completa todos los campos.');
                    return;
                }

                if (!isLoginMode && passwordInput !== confirmPasswordInput) {
                    showAuthMessage('Las contraseÃ±as no coinciden.');
                    return;
                }

                if (isLoginMode) {
                    loginUser(usernameInput, passwordInput, result => {
                        if (result.success) {
                            username = usernameInput;
                            sessionId = result.sessionId;
                            authContainer.classList.remove('active');
                            if (result.policiesAccepted && result.policiesVersion === POLICIES_VERSION) {
                                gameContainer.classList.add('active');
                                initializeGame();
                            } else {
                                policiesContainer.classList.add('active');
                            }
                        } else {
                            showAuthMessage('Usuario o contraseÃ±a incorrectos.');
                        }
                    });
                } else {
                    registerUser(usernameInput, passwordInput, success => {
                        if (success) {
                            username = usernameInput;
                            authContainer.classList.remove('active');
                            policiesContainer.classList.add('active');
                        } else {
                            showAuthMessage('El usuario ya existe.');
                        }
                    });
                }
            }

            function toggleAuthMode() {
                isLoginMode = !isLoginMode;
                authTitle.textContent = isLoginMode ? 'Iniciar SesiÃ³n' : 'Registrarse';
                authSubmit.textContent = isLoginMode ? 'Iniciar SesiÃ³n' : 'Registrarse';
                authToggle.textContent = isLoginMode ? 'Â¿No tienes cuenta? RegÃ­strate' : 'Â¿Ya tienes cuenta? Inicia sesiÃ³n';
                authConfirmPassword.style.display = isLoginMode ? 'none' : 'block';
                forgotPassword.style.display = isLoginMode ? 'block' : 'none';
                showAuthMessage('');
                authUsername.value = '';
                authPassword.value = '';
                authConfirmPassword.value = '';
            }

            // Funciones de polÃ­ticas
            function handlePoliciesAccept() {
                updateUserPolicies(username, true, POLICIES_VERSION);
                policiesContainer.classList.remove('active');
                gameContainer.classList.add('active');
                initializeGame();
            }

            function handlePoliciesReject() {
                updateUserPolicies(username, false, POLICIES_VERSION);
                policiesContainer.classList.remove('active');
                gameContainer.classList.add('active');
                showMessage('Has rechazado las PolÃ­ticas y Condiciones. El botÃ³n "Jugar" estÃ¡ bloqueado.');
                initializeGame();
            }

            function updatePoliciesStatus() {
                getUser(username, user => {
                    try {
                        if (user && user.policiesAccepted && user.policiesVersion === POLICIES_VERSION) {
                            policiesStatus.classList.remove('rejected');
                            policiesStatus.classList.add('accepted');
                            policiesCheckbox.checked = true;
                            policiesText.textContent = 'Ud. aceptÃ³ las ';
                        } else {
                            policiesStatus.classList.remove('accepted');
                            policiesStatus.classList.add('rejected');
                            policiesCheckbox.checked = false;
                            policiesText.textContent = 'Ud. no aceptÃ³ las ';
                        }
                    } catch (error) {
                        console.error('Error al actualizar estado de polÃ­ticas:', error);
                    }
                });
            }

            function showPoliciesWindow() {
                try {
                    const policiesWindow = window.open('', '_blank');
                    if (policiesWindow) {
                        policiesWindow.document.write(policiesHtml);
                        policiesWindow.document.close();
                    } else {
                        showMessage('No se pudo abrir la ventana de polÃ­ticas. Desactiva el bloqueador de ventanas emergentes.');
                        const dataUrl = 'data:text/html;charset=utf-8,' + encodeURIComponent(policiesHtml);
                        const link = document.createElement('a');
                        link.href = dataUrl;
                        link.download = 'politicas_y_condiciones.html';
                        link.textContent = 'Descargar PolÃ­ticas';
                        link.style.color = '#03a9f4';
                        link.style.textDecoration = 'underline';
                        link.style.fontSize = '0.7rem';
                        messageBox.appendChild(document.createElement('br'));
                        messageBox.appendChild(link);
                    }
                } catch (error) {
                    console.error('Error al mostrar ventana de polÃ­ticas:', error);
                    showMessage('Error al mostrar polÃ­ticas.');
                }
            }

            // Funciones de estadÃ­sticas
            function showStatsWindow() {
                try {
                    const statsWindow = window.open('', '_blank');
                    if (statsWindow) {
                        statsWindow.document.write(statsHtml);
                        statsWindow.document.close();
                    } else {
                        showMessage('No se pudo abrir la ventana de estadÃ­sticas. Desactiva el bloqueador de ventanas emergentes.');
                        const dataUrl = 'data:text/html;charset=utf-8,' + encodeURIComponent(statsHtml);
                        const link = document.createElement('a');
                        link.href = dataUrl;
                        link.download = 'estadisticas_juego.html';
                        link.textContent = 'Descargar EstadÃ­sticas';
                        link.style.color = '#03a9f4';
                        link.style.textDecoration = 'underline';
                        link.style.fontSize = '0.7rem';
                        messageBox.appendChild(document.createElement('br'));
                        messageBox.appendChild(link);
                    }
                } catch (error) {
                    console.error('Error al mostrar estadÃ­sticas:', error);
                    showMessage('Error al cargar estadÃ­sticas.');
                }
            }

            // Funciones de configuraciÃ³n
            function loadUserSettings() {
                getUser(username, user => {
                    try {
                        if (user && user.settings) {
                            settingsDisplayName.value = user.settings.displayName || '';
                            settingsEmail.value = user.settings.email || '';
                            settingsCvu.value = user.settings.cvu || '';
                            settingsMetamask.value = user.settings.metamask || '';
                        }
                    } catch (error) {
                        console.error('Error al cargar configuraciÃ³n:', error);
                        showSettingsMessage('Error al cargar configuraciÃ³n.');
                    }
                });
            }

            function handleSettingsSave() {
                try {
                    const settings = {
                        displayName: settingsDisplayName.value.trim(),
                        email: settingsEmail.value.trim(),
                        cvu: settingsCvu.value.trim(),
                        metamask: settingsMetamask.value.trim()
                    };
                    updateUserSettings(username, settings);
                    showSettingsMessage('ConfiguraciÃ³n guardada exitosamente.');
                    setTimeout(() => {
                        settingsContainer.classList.remove('active');
                        gameContainer.classList.add('active');
                        showSettingsMessage('');
                    }, 1000);
                } catch (error) {
                    console.error('Error al guardar configuraciÃ³n:', error);
                    showSettingsMessage('Error al guardar configuraciÃ³n.');
                }
            }

            function handleSettingsBack() {
                settingsContainer.classList.remove('active');
                gameContainer.classList.add('active');
                showSettingsMessage('');
            }

            // Funciones de retiro
            async function sendWithdrawalNotification(amount, currency, realName, displayName, cvu) {
                try {
                    if (typeof emailjs === 'undefined') {
                        throw new Error('EmailJS no estÃ¡ disponible');
                    }
                    const templateParams = {
                        amount: amount,
                        currency: currency,
                        real_name: realName,
                        display_name: displayName || realName,
                        cvu: cvu || 'No proporcionado',
                        to_email: 'rod.arena7@gmail.com'
                    };
                    await emailjs.send('service_7du0586', '__ejs-test-mail-service__', templateParams);
                    showWithdrawMessage('Solicitud de retiro enviada.');
                } catch (error) {
                    console.error('Error al enviar notificaciÃ³n:', error);
                    showWithdrawMessage('Error al enviar solicitud de retiro. Verifica la configuraciÃ³n de EmailJS.');
                }
            }

            function handleWithdraw() {
                withdrawForm.classList.add('active');
                gameContainer.classList.remove('active');
                withdrawAmount.value = '';
                withdrawCurrency.value = 'Neig';
                showWithdrawMessage('');
            }

            function handleWithdrawSubmit() {
                try {
                    const amount = parseInt(withdrawAmount.value);
                    const currency = withdrawCurrency.value;
                    getUser(username, user => {
                        const settings = user.settings || {};
                        if (!amount || amount <= 0) {
                            showWithdrawMessage('Por favor, ingresa una cantidad vÃ¡lida.');
                            return;
                        }
                        if (amount > playerCoins) {
                            showWithdrawMessage('No tienes suficientes Neig para retirar.');
                            return;
                        }
                        if (!settings.cvu && currency === 'Pesos') {
                            showWithdrawMessage('Por favor, ingresa un CVU/CBU o Alias en ConfiguraciÃ³n.');
                            return;
                        }
                        if (!settings.metamask && currency === 'Neig') {
                            showWithdrawMessage('Por favor, ingresa una direcciÃ³n MetaMask en ConfiguraciÃ³n.');
                            return;
                        }
                        playerCoins -= amount;
                        updateUserCoins(username, playerCoins);
                        updatePlayerInfo();
                        sendWithdrawalNotification(amount, currency, username, settings.displayName, settings.cvu);
                        withdrawForm.classList.remove('active');
                        gameContainer.classList.add('active');
                        showMessage(`Solicitud de retiro de ${amount} ${currency} enviada.`);
                    });
                } catch (error) {
                    console.error('Error al procesar retiro:', error);
                    showWithdrawMessage('Error al procesar retiro.');
                }
            }

            function handleWithdrawCancel() {
                withdrawForm.classList.remove('active');
                gameContainer.classList.add('active');
                showWithdrawMessage('');
            }

            // Funciones para actualizar la UI
            function updatePotDisplay() {
                try {
                    if (potDisplay) {
                        potDisplay.textContent = `Pozo: ${pot} Neig`;
                    }
                } catch (error) {
                    console.error('Error al actualizar pozo:', error);
                }
            }

            function updateTimerDisplay(seconds) {
                try {
                    if (timerDisplay) {
                        const minutes = Math.floor(seconds / 60);
                        const secs = Math.floor(seconds) % 60;
                        const milliseconds = Math.floor((seconds - Math.floor(seconds)) * 100);
                        timerDisplay.querySelector('p').textContent = `Tiempo Restante: ${minutes}:${secs < 10 ? '0' : ''}${secs}:${milliseconds < 10 ? '0' : ''}${milliseconds}`;
                        const percentage = Math.max(0, (seconds / 240) * 100);
                        progressBarFill.style.width = `${percentage}%`;
                        timerPercentageDisplay.textContent = `${Math.ceil(percentage)}%`;
                    }
                } catch (error) {
                    console.error('Error al actualizar temporizador:', error);
                }
            }

            function updatePlayerInfo() {
                getUser(username, user => {
                    try {
                        const displayName = user && user.settings && user.settings.displayName ? user.settings.displayName : username;
                        if (usernameDisplay) {
                            usernameDisplay.textContent = `Usuario: ${displayName}`;
                        }
                        if (coinsDisplay) {
                            coinsDisplay.textContent = `Saldo: ${playerCoins} Neig`;
                        }
                        if (competeButton) {
                            competeButton.disabled = !user.policiesAccepted || user.policiesVersion !== POLICIES_VERSION || hasParticipated;
                        }
                        updatePoliciesStatus();
                    } catch (error) {
                        console.error('Error al actualizar info del jugador:', error);
                    }
                });
            }

            // Funciones del juego
            function startTimer() {
                let seconds = 240;
                updateTimerDisplay(seconds);
                timerInterval = setInterval(() => {
                    seconds -= 0.1;
                    if (seconds <= 0) {
                        endTimer();
                    }
                    updateTimerDisplay(seconds);
                }, 100);
            }

            function endTimer() {
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                try {
                    if (hasParticipated) {
                        const playerWinAmount = Math.round(pot * 0.89);
                        const developerWinAmount = Math.round(pot * developerPercentage);
                        const potLeftover = Math.round(pot * potPercentage);
                        playerCoins += playerWinAmount;
                        updateUserCoins(username, playerCoins);
                        showMessage(`Â¡Felicidades! Has ganado ${playerWinAmount} Neig.`);
                        pot = potLeftover;
                        hasParticipated = false;
                    } else {
                        showMessage('El tiempo se agotÃ³ y nadie participÃ³.');
                        pot = 0;
                    }
                    updatePotDisplay();
                    updatePlayerInfo();
                    if (competeButton) {
                        competeButton.disabled = false;
                        competeButton.textContent = 'Jugar';
                    }
                } catch (error) {
                    console.error('Error al finalizar temporizador:', error);
                    showMessage('Error al finalizar ronda.');
                }
            }

            function handleCompete() {
                getUser(username, user => {
                    try {
                        if (!user.policiesAccepted || user.policiesVersion !== POLICIES_VERSION) {
                            showMessage('Debes aceptar las PolÃ­ticas y Condiciones para jugar.');
                            return;
                        }
                        if (playerCoins >= 100) {
                            if (!hasParticipated) {
                                playerCoins -= 100;
                                pot += 100;
                                updateUserCoins(username, playerCoins);
                                updatePlayerInfo();
                                updatePotDisplay();
                                hasParticipated = true;
                                if (competeButton) {
                                    competeButton.disabled = true;
                                    competeButton.textContent = 'Esperando...';
                                }
                                if (!timerInterval) {
                                    startTimer();
                                }
                                showMessage('Has apostado 100 Neig.');
                            } else {
                                showMessage('Ya has participado en esta ronda.');
                            }
                        } else {
                            showMessage('No tienes suficientes Neig para participar.');
                        }
                    } catch (error) {
                        console.error('Error al competir:', error);
                        showMessage('Error al procesar apuesta.');
                    }
                });
            }

            function handleReload() {
                try {
                    playerCoins += 1000;
                    updateUserCoins(username, playerCoins);
                    updatePlayerInfo();
                    showMessage('Se han recargado 1000 Neig.');
                } catch (error) {
                    console.error('Error al recargar:', error);
                    showMessage('Error al recargar Neig.');
                }
            }

            function handleLogout() {
                try {
                    socket.emit('leave', username);
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('session_' + username);
                    authContainer.classList.add('active');
                    gameContainer.classList.remove('active');
                    showAuthMessage('SesiÃ³n cerrada.');
                    username = null;
                    playerCoins = 1000;
                    isLoginMode = true;
                    authTitle.textContent = 'Iniciar SesiÃ³n';
                    authSubmit.textContent = 'Iniciar SesiÃ³n';
                    authToggle.textContent = 'Â¿No tienes cuenta? RegÃ­strate';
                    authUsername.value = '';
                    authPassword.value = '';
                    authConfirmPassword.value = '';
                    if (timerInterval) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                    }
                } catch (error) {
                    console.error('Error al cerrar sesiÃ³n:', error);
                    showAuthMessage('Error al cerrar sesiÃ³n.');
                }
            }

            function initializeGame() {
                try {
                    if (!checkSession(username)) {
                        handleLogout();
                        showAuthMessage('SesiÃ³n iniciada en otro dispositivo.');
                        return;
                    }
                    getUser(username, user => {
                        playerCoins = user.coins || 1000;
                        const displayName = user.settings && user.settings.displayName ? user.settings.displayName : username;
                        socket.emit('join', displayName);
                        updatePlayerInfo();
                        updatePotDisplay();
                        showMessage(`Â¡Bienvenido, ${username}!`);
                    });
                } catch (error) {
                    console.error('Error al inicializar juego:', error);
                    showMessage('Error al inicializar el juego.');
                }
            }

            // Verificar usuario logueado
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                getUser(currentUser, user => {
                    try {
                        if (user && checkSession(currentUser)) {
                            username = currentUser;
                            playerCoins = user.coins || 1000;
                            authContainer.classList.remove('active');
                            if (user.policiesAccepted && user.policiesVersion === POLICIES_VERSION) {
                                gameContainer.classList.add('active');
                                initializeGame();
                            } else {
                                policiesContainer.classList.add('active');
                            }
                        } else {
                            localStorage.removeItem('currentUser');
                            showAuthMessage('Inicia sesiÃ³n nuevamente.');
                        }
                    } catch (error) {
                        console.error('Error al verificar usuario:', error);
                        showAuthMessage('Error al verificar sesiÃ³n.');
                    }
                });
            }

            // Event listeners
            authSubmit.addEventListener('click', handleAuthSubmit);
            authToggle.addEventListener('click', toggleAuthMode);
            authPassword.addEventListener('keypress', e => {
                if (e.key === 'Enter') handleAuthSubmit();
            });
            forgotPassword.addEventListener('click', () => {
                showAuthMessage('FunciÃ³n de recuperaciÃ³n de contraseÃ±a no implementada. Contacta al soporte.');
            });
            competeButton.addEventListener('click', handleCompete);
            reloadButton.addEventListener('click', handleReload);
            withdrawButton.addEventListener('click', handleWithdraw);
            settingsButton.addEventListener('click', () => {
                gameContainer.classList.remove('active');
                settingsContainer.classList.add('active');
                loadUserSettings();
            });
            logoutButton.addEventListener('click', handleLogout);
            settingsSave.addEventListener('click', handleSettingsSave);
            settingsBack.addEventListener('click', handleSettingsBack);
            withdrawSubmit.addEventListener('click', handleWithdrawSubmit);
            withdrawCancel.addEventListener('click', handleWithdrawCancel);
            policiesAccept.addEventListener('click', handlePoliciesAccept);
            policiesReject.addEventListener('click', handlePoliciesReject);
            policiesLink.addEventListener('click', showPoliciesWindow);
            statsButton.addEventListener('click', showStatsWindow);
        });
    </script>
</body>
</html>
